<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FitTrack | Workouts</title>

  <!-- Google Fonts & FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <script defer src="https://kit.fontawesome.com/a2e8f1b6b1.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Chart.js & storage helper -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="storage.js"></script>

  <style>
    :root {
      --bg:#000; --gold:#ff9800; --white:#fff;
      --font-base:'Raleway',sans-serif;
      --font-head:'Poppins',sans-serif;
      --transition:.3s ease;
      --sidebar-w:80px; --mobile-break:900px;
      --z-sidebar:100; --z-header:200;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{display:flex;min-height:100vh;background:var(--bg);color:var(--white);
      font-family:var(--font-base);overflow-x:hidden;}
    a{color:inherit;text-decoration:none;}
    button,select,input,textarea{
      font-family:var(--font-head);transition:var(--transition);
      cursor:pointer;border:none;border-radius:30px;
      padding:.6rem 1.2rem;background:var(--gold);color:var(--bg);
    }
    input,textarea,select{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.3);}
    select{appearance:none;padding-right:2.5rem;
      background-image:url('data:image/svg+xml;charset=UTF-8,<svg fill="%23fff" viewBox="0 0 320 512"><path d="M31 192h258c17.7 0 26.7 21.5 14.1 34l-129 129a16 16 0 01-22.6 0l-129-129c-12.6-12.5-3.6-34 14.5-34z"/></svg>');
      background-repeat:no-repeat;background-position:right .75rem center;
      background-size:.65rem auto;
    }
    button:hover,select:hover,input:hover,textarea:hover{
      transform:scale(1.03);box-shadow:0 2px 8px rgba(0,0,0,0.4);
    }

    /* overlay */
    #overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);
      opacity:0;visibility:hidden;transition:opacity var(--transition);
      z-index:var(--z-header);}
    #overlay.active{opacity:1;visibility:visible;}

    /* SIDEBAR */
    .sidebar{width:var(--sidebar-w);background:rgba(0,0,0,0.9);
      border-right:2px solid var(--gold);display:flex;flex-direction:column;
      align-items:center;padding:1rem 0;position:sticky;top:0;height:100vh;
      z-index:var(--z-sidebar);}
    @media(max-width:var(--mobile-break)){
      .sidebar{position:fixed;transform:translateX(-100%);width:200px;}
      .sidebar.open{transform:translateX(0);}
    }
    .sidebar-close{display:none;}
    @media(max-width:var(--mobile-break)) .sidebar-close{display:block;align-self:flex-end;
      margin:.5rem;font-size:1.5rem;background:none;color:var(--white);}
    .sidebar .logo{font-size:1.8rem;color:var(--gold);margin-bottom:2rem;}
    .sidebar a.menu-item,.sidebar button.profile-menu{
      width:100%;padding:.8rem 0;display:flex;flex-direction:column;align-items:center;
      gap:.3rem;background:transparent;color:var(--white);transition:background var(--transition);}
    .sidebar a.menu-item.active,
    .sidebar a.menu-item:hover,
    .sidebar button.profile-menu:hover{background:rgba(255,152,0,0.2);}
    .sidebar a.menu-item i,
    .sidebar button.profile-menu i.avatar{font-size:1.4rem;}
    .sidebar a.menu-item span,
    .sidebar button.profile-menu span{font-size:.75rem;}
    .sidebar a.sign-out{margin-top:auto;margin-bottom:1rem!important;}
    img.avatar,i.avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;
      border:2px solid var(--white);}

    /* MAIN & HEADER */
    .main{flex:1;display:flex;flex-direction:column;margin-left:var(--sidebar-w);}
    @media(max-width:var(--mobile-break)) .main{margin-left:0;}

    header{display:flex;align-items:center;justify-content:space-between;
      padding:1rem 1.5rem;background:rgba(0,0,0,0.9);border-bottom:2px solid var(--gold);
      position:sticky;top:0;z-index:var(--z-header);}
    .header-left{display:flex;align-items:center;gap:1rem;flex:1;}
    .header-left h1{font-size:1.4rem;display:flex;align-items:center;gap:.5rem;}
    .header-right{display:flex;align-items:center;gap:1rem;}
    .new-workout{background:var(--gold);color:var(--bg);border-radius:30px;padding:.6rem 1rem;font-size:1.1rem;}
    .hamburger{display:none;background:none;border:none;color:var(--white);font-size:1.5rem;}
    @media(max-width:var(--mobile-break)) .hamburger{display:inline-flex;}
    #profile-btn{background:none;border:none;color:var(--white);font-size:1.5rem;}

    /* Welcome banner */
    #welcomeBanner{background:rgba(255,152,0,0.1);color:var(--white);
      text-align:center;padding:.75rem 1.5rem;font-size:1rem;}

    /* GRID */
    .content{padding:1.5rem;display:grid;gap:2rem;grid-template-columns:1fr 1fr;}
    @media(max-width:900px) .content{grid-template-columns:1fr;}

    /* WORKOUT OF THE DAY */
    #workoutOfDay{grid-column:1/-1;background:rgba(255,255,255,0.05);
      border-radius:12px;padding:1.5rem;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
    #workoutOfDay h2{display:flex;align-items:center;gap:.5rem;color:var(--gold);font-size:1.4rem;}
    #workoutOfDay button{background:var(--gold);color:var(--bg);margin-top:.75rem;}

    /* FEATURED */
    section#featuredWorkouts h2,
    section#library h2{margin-bottom:1rem;color:var(--gold);
      display:flex;align-items:center;gap:.5rem;font-size:1.3rem;}
    .card-grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));}
    .card{background:rgba(255,255,255,0.05);border-radius:12px;overflow:hidden;
      box-shadow:0 4px 12px rgba(0,0,0,0.5);display:flex;flex-direction:column;height:100%;}
    .card img{width:100%;height:140px;object-fit:cover;}
    .card-body{padding:1rem;flex:1;display:flex;flex-direction:column;}
    .card-body h3{margin-bottom:.5rem;font-size:1.1rem;}
    .card-body p.info{opacity:.8;margin-bottom:.5rem;font-size:.9rem;}
    .card-body p.desc{flex:1;line-height:1.3;margin-bottom:.5rem;font-size:.9rem;}
    .card-body button{background:var(--gold);color:var(--bg);padding:.6rem;border-radius:6px;}

    /* DETAIL MODAL */
    #detailModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);
      align-items:center;justify-content:center;padding:1rem;z-index:95;}
    #detailModal .modal-content{background:rgba(0,0,0,0.9);border-radius:12px;
      padding:1.5rem;width:100%;max-width:600px;max-height:90%;overflow-y:auto;position:relative;}
    #detailModal .close{position:absolute;top:1rem;right:1rem;font-size:1.5rem;color:var(--gold);cursor:pointer;}

    /* MY PLANS, PROGRESS, CHALLENGES, LIVE */
    #myPlans, #progressSummary, #challengeModes, #liveSessions{
      grid-column:1/-1;background:rgba(255,255,255,0.05);border-radius:12px;padding:1rem;
      box-shadow:0 4px 12px rgba(0,0,0,0.5);}
    #myPlans ul{list-style:none;display:flex;flex-wrap:wrap;gap:1rem;padding:0;}
    #myPlans li{flex:1 1 calc(50% - 1rem);background:rgba(255,255,255,0.1);
      padding:.6rem .8rem;border-radius:6px;display:flex;justify-content:space-between;
      align-items:center;font-size:.9rem;}
    #myPlans button{background:none;color:var(--gold);}

    #progressSummary h2,#challengeModes h2,#liveSessions h2{font-size:1.3rem;color:var(--gold);margin-bottom:1rem;}
    #progressChart{width:100%!important;height:240px!important;}

    .challenge{background:rgba(255,255,255,0.1);border-radius:8px;padding:1rem;
      display:flex;flex-direction:column;justify-content:space-between;position:relative;}
    .challenge:hover{transform:translateY(-4px);}
    .challenge .prog-bar{background:rgba(255,255,255,0.2);border-radius:6px;overflow:hidden;height:14px;margin-bottom:.5rem;}
    .challenge .fill{height:100%;background:var(--gold);width:0;transition:width 1s ease;}
    .challenge button{background:var(--gold);color:var(--bg);padding:.5rem .8rem;border-radius:6px;margin-top:.5rem;}
    .challenge .restart{background:transparent;color:var(--gold);border:1px solid var(--gold);}

    .live-grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));}
    .live-card{position:relative;background:rgba(255,255,255,0.1);border-radius:8px;
      padding:1rem;display:flex;flex-direction:column;justify-content:space-between;}
    .live-card:hover{transform:translateY(-4px);}
    .live-card img{width:100%;height:100px;object-fit:cover;border-radius:6px;margin-bottom:.5rem;}
    .live-card .status{position:absolute;top:8px;left:8px;background:red;color:#fff;
      padding:.2rem .5rem;border-radius:4px;font-size:.8rem;}
    .live-card button{background:var(--gold);color:var(--bg);padding:.5rem .8rem;}

    /* GO LIVE MODAL */
    #goLiveModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);
      align-items:center;justify-content:center;padding:1rem;z-index:300;}
    #goLiveModal .modal{background:var(--bg);padding:1.5rem;border:2px solid var(--gold);
      border-radius:8px;max-width:360px;width:90%;position:relative;}
    #goLiveModal .close{position:absolute;top:1rem;right:1rem;font-size:1.5rem;color:var(--gold);cursor:pointer;}

    /* CHATBOT & TOGGLE (unchanged) */
    #chatbot{position:fixed;bottom:20px;right:20px;width:320px;max-height:420px;
      background:#fff;color:#222;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,0.15);
      display:none;flex-direction:column;overflow:hidden;font-family:'Poppins',sans-serif;
      border:1px solid #ddd;z-index:400;}
    /* … rest of chatbot CSS unchanged … */

  </style>
</head>
<body>
  <div id="overlay"></div>

  <!-- SIDEBAR -->
  <aside id="sidebar" class="sidebar">
    <button id="sidebar-close" class="sidebar-close">&times;</button>
    <div class="logo"><i class="fas fa-heartbeat"></i></div>
    <a href="dashboard.html" class="menu-item"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
    <a href="log.html"        class="menu-item"><i class="fas fa-pen"></i><span>Log</span></a>
    <a href="workouts.html"   class="menu-item active"><i class="fas fa-dumbbell"></i><span>Workouts</span></a>
    <a href="leaderboard.html"class="menu-item"><i class="fas fa-trophy"></i><span>Board</span></a>
    <button class="menu-item profile-menu">
      <i id="side-avatar" class="fas fa-user-circle avatar"></i><span>Profile</span>
    </button>
    <a href="home.html" class="menu-item sign-out"><i class="fas fa-sign-out-alt"></i><span>Sign Out</span></a>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <header>
      <div class="header-left">
        <button id="hamburger" class="hamburger"><i class="fas fa-bars"></i></button>
        <h1><i class="fas fa-dumbbell"></i> Workouts</h1>
      </div>
      <div class="header-right">
        <button class="new-workout"><i class="fas fa-plus"></i></button>
      </div>
      <button id="profile-btn" class="profile-btn"><i id="top-avatar" class="fas fa-user-circle avatar"></i></button>
    </header>

    <div id="welcomeBanner"></div>

    <div class="content">
      <!-- Workout of the Day -->
      <section id="workoutOfDay">
        <h2><i class="fas fa-star"></i> Workout of the Day</h2>
        <p id="wodTitle">Loading…</p>
        <p id="wodDesc"></p>
        <button id="randomizeWOD">Randomize</button>
      </section>

      <!-- Featured Workouts -->
      <section id="featuredWorkouts">
        <h2><i class="fas fa-fire"></i> Featured Workouts</h2>
        <div class="card-grid" id="featuredList"></div>
      </section>

      <!-- Browse Library Redesigned -->
      <section id="library">
        <h2><i class="fas fa-book-open"></i> Popular Categories</h2>
        <div class="card-grid" id="categoryList"></div>
        <h2><i class="fas fa-list"></i> All Workouts</h2>
        <div class="card-grid" id="libraryGrid"></div>
      </section>

      <!-- Detail Modal -->
      <div id="detailModal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2 id="detailTitle"></h2>
          <p id="detailDesc"></p>
          <ul id="detailList"></ul>
          <p><strong>Equipment:</strong> <span id="detailEquip"></span></p>
          <p><strong>Calories:</strong> <span id="detailCal">0</span></p>
          <div style="margin-top:1rem;display:flex;gap:1rem;">
            <button id="detailStart">Log This Workout</button>
            <button id="savePlan">Save to My Plans</button>
          </div>
        </div>
      </div>

      <!-- My Plans -->
      <section id="myPlans">
        <h2><i class="fas fa-bookmark"></i> My Plans</h2>
        <ul id="plansList"></ul>
      </section>

      <!-- Progress Chart -->
      <section id="progressSummary">
        <h2><i class="fas fa-chart-line"></i> Sessions by Category</h2>
        <canvas id="progressChart"></canvas>
      </section>

      <!-- Challenge Modes -->
      <section id="challengeModes">
        <h2><i class="fas fa-flag"></i> Challenge Modes</h2>
        <div class="challenges-grid" id="challengesList"></div>
      </section>

      <!-- Live Sessions -->
      <section id="liveSessions">
        <h2><i class="fas fa-video"></i> Live Sessions</h2>
        <div class="live-grid" id="sessionsList"></div>
      </section>
    </div>
  </div>

  <!-- Go Live Modal -->
  <div id="goLiveModal">
    <div class="modal">
      <span class="close">&times;</span>
      <h2>Start Your Live Workout</h2>
      <label>Name of Workout</label>
      <input type="text" id="live-name" placeholder="e.g. HIIT Blast"/>
      <label>Description</label>
      <textarea id="live-desc" rows="3" placeholder="Brief description…"></textarea>
      <button id="startLiveBtn">Go Live Now</button>
    </div>
  </div>

  <!-- Chatbot Toggle & Panel (unchanged) -->
  <!-- … -->

  <script type="module">
  import { Storage } from './storage.js';

  document.addEventListener('DOMContentLoaded', () => {
    // → Redirect if not signed in
    const cur = Storage.get('ft_current', null);
    if (!cur || !cur.name) return location.replace('home.html');

    // ELEMENTS
    const sidebar      = document.getElementById('sidebar'),
          overlay      = document.getElementById('overlay'),
          openBtn      = document.getElementById('hamburger'),
          closeBtn     = document.getElementById('sidebar-close'),
          profileBtns  = [ document.getElementById('profile-btn'),
                            document.querySelector('.profile-menu') ],
          sideAvatarEl = document.getElementById('side-avatar'),
          topAvatarEl  = document.getElementById('top-avatar'),
          welcomeEl    = document.getElementById('welcomeBanner'),
          newBtn       = document.querySelector('.new-workout'),
          goLiveModal  = document.getElementById('goLiveModal'),
          goClose      = goLiveModal.querySelector('.close'),
          startLiveBtn = document.getElementById('startLiveBtn'),
          wodTitle     = document.getElementById('wodTitle'),
          wodDesc      = document.getElementById('wodDesc'),
          rndBtn       = document.getElementById('randomizeWOD'),
          featuredList = document.getElementById('featuredList'),
          categoryList = document.getElementById('categoryList'),
          libraryGrid  = document.getElementById('libraryGrid'),
          detailModal  = document.getElementById('detailModal'),
          detailClose  = detailModal.querySelector('.close'),
          detailTitle  = document.getElementById('detailTitle'),
          detailDesc   = document.getElementById('detailDesc'),
          detailList   = document.getElementById('detailList'),
          detailEquip  = document.getElementById('detailEquip'),
          detailCal    = document.getElementById('detailCal'),
          btnLog       = document.getElementById('detailStart'),
          btnSavePlan  = document.getElementById('savePlan'),
          plansList    = document.getElementById('plansList'),
          ctx          = document.getElementById('progressChart').getContext('2d'),
          chList       = document.getElementById('challengesList'),
          sessList     = document.getElementById('sessionsList');

    // SIDEBAR TOGGLE & NAV
    openBtn.onclick  = ()=>{ sidebar.classList.add('open'); overlay.classList.add('active'); };
    closeBtn.onclick = overlay.onclick = ()=>{ sidebar.classList.remove('open'); overlay.classList.remove('active'); };
    profileBtns.forEach(b => b.onclick = ()=> location.replace('profile.html'));

    // SWAP AVATARS (sidebar & header)
    function updateAvatars(){
      const pf = Storage.get('ft_profile', {}),
            src = pf.avatarDataUrl || `https://i.pravatar.cc/150?u=${cur.email}`;
      [sideAvatarEl, topAvatarEl].forEach(old=>{
        if (!old) return;
        const img = document.createElement('img');
        img.id = old.id; img.className='avatar'; img.src = src;
        old.replaceWith(img);
      });
    }
    Storage.onChange('ft_profile', updateAvatars);
    updateAvatars();

    // WELCOME
    welcomeEl.textContent = `Welcome back, ${cur.name}!`;

    // GO LIVE MODAL wiring
    newBtn.onclick       = ()=> goLiveModal.style.display='flex';
    goClose.onclick      = ()=> goLiveModal.style.display='none';
    startLiveBtn.onclick = async()=>{
      goLiveModal.style.display='none';
      try {
        const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        const vid = document.createElement('video');
        vid.srcObject = stream; vid.autoplay = true;
        vid.style.cssText = 'position:fixed;bottom:80px;right:20px;width:200px;z-index:500;';
        document.body.appendChild(vid);
        const endBtn = document.createElement('button');
        endBtn.textContent = 'End Live';
        Object.assign(endBtn.style,{
          position:'fixed',bottom:'20px',right:'20px',padding:'.5rem 1rem',
          background:'#ff5252',color:'#fff',borderRadius:'6px',zIndex:501
        });
        document.body.appendChild(endBtn);
        endBtn.onclick = ()=>{
          stream.getTracks().forEach(t=>t.stop());
          vid.remove(); endBtn.remove();
        };
      } catch {
        alert('Camera access denied');
      }
    };

    // WORKOUT DATA
    const workouts = [
      { id:1,title:'Full‑Body HIIT',      category:'Cardio',   duration:20, difficulty:'Intermediate',image:'hiit.jpg',   description:'Fast‑paced intervals.', exercises:['Jumping Jacks','Burpees','Mountain Climbers'], equipment:'None', calories:200 },
      { id:2,title:'Upper Body Strength', category:'Strength', duration:45, difficulty:'Advanced',      image:'upper.jpg',  description:'Build power with weights.', exercises:['Push‑Ups','Pull‑Ups','Rows'],             equipment:'Dumbbells', calories:300 },
      { id:3,title:'Morning Yoga Flow',   category:'Yoga',     duration:30, difficulty:'Beginner',      image:'yoga.jpg',   description:'Gentle wake‑up sequences.', exercises:['Sun Salutation','Tree Pose','Child’s Pose'],equipment:'Mat', calories:120 },
      { id:4,title:'Tabata Burn',         category:'Cardio',   duration:15, difficulty:'Advanced',      image:'tabata.jpg', description:'High‑intensity Tabata rounds.', exercises:['20/10 Work‑Rest'],              equipment:'None', calories:180 },
      { id:5,title:'Lower Body Blast',    category:'Strength', duration:40, difficulty:'Intermediate',image:'lower.jpg',  description:'Squats & lunges focus.', exercises:['Squats','Lunges','Deadlifts'],          equipment:'Barbell', calories:250 },
      { id:6,title:'Core Crusher',        category:'Core',     duration:25, difficulty:'Intermediate',image:'abs.jpg',    description:'Abs & obliques workout.', exercises:['Plank','Russian Twists','Leg Raises'],    equipment:'None', calories:150 },
      { id:7,title:'Pilates Power',       category:'Pilates',  duration:35, difficulty:'Beginner',      image:'pilate.jpg', description:'Full‑body Pilates flow.', exercises:['Roll‑Up','Hundred','Leg Circles'],        equipment:'Mat', calories:130 },
      { id:8,title:'Kickboxing Cardio',   category:'Cardio',   duration:30, difficulty:'Advanced',      image:'bag.jpg',    description:'Punch & kick combos.', exercises:['Jab‑Cross','Front Kick','Hook'],            equipment:'Gloves', calories:300 }
    ];

    // WORKOUT OF THE DAY
    function pickWOD(){
      const w = workouts[Math.floor(Math.random()*workouts.length)];
      wodTitle.textContent = w.title;
      wodDesc .textContent = w.description;
    }
    rndBtn.onclick = pickWOD; pickWOD();

    // FEATURED
    function renderFeatured(){
      featuredList.innerHTML = '';
      workouts.slice(0,6).forEach(w=>{
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `
          <img src="${w.image}" alt="${w.title}">
          <div class="card-body">
            <h3>${w.title}</h3>
            <p class="info">${w.category} • ${w.duration}m • ${w.difficulty}</p>
            <p class="desc">${w.description}</p>
            <button data-id="${w.id}">Details</button>
          </div>`;
        featuredList.append(card);
      });
    }

    // POPULAR CATEGORIES
    function renderCategories(){
      const cats = [...new Set(workouts.map(w=>w.category))];
      categoryList.innerHTML = '';
      cats.forEach(cat=>{
        const count   = workouts.filter(w=>w.category===cat).length,
              imgSrc  = workouts.find(w=>w.category===cat).image,
              card    = document.createElement('div'); card.className='card';
        card.innerHTML = `
          <img src="${imgSrc}" alt="${cat}">
          <div class="card-body">
            <h3>${cat}</h3>
            <p>${count} workouts</p>
            <button class="explore" data-cat="${cat}">Explore</button>
          </div>`;
        categoryList.append(card);
      });
      // EXPLORE CLICK HANDLER
      categoryList.querySelectorAll('.explore').forEach(b=>{
        b.onclick = ()=> renderAllWorkouts(b.dataset.cat);
      });
    }

    // ALL WORKOUTS (optionally filtered)
    function renderAllWorkouts(filter=''){
      libraryGrid.innerHTML = '';
      workouts.filter(w=>!filter||w.category===filter)
        .forEach(w=>{
          const card = document.createElement('div'); card.className='card';
          card.innerHTML = `
            <img src="${w.image}" alt="${w.title}">
            <div class="card-body">
              <h3>${w.title}</h3>
              <p class="info">${w.category} • ${w.duration}m • ${w.difficulty}</p>
              <p class="desc">${w.description}</p>
              <button data-id="${w.id}">Details</button>
            </div>`;
          libraryGrid.append(card);
        });
    }

    // DETAIL MODAL
    detailClose.onclick = ()=> detailModal.style.display='none';
    document.body.addEventListener('click', e=>{
      if(e.target.tagName==='BUTTON'&&e.target.dataset.id){
        const w = workouts.find(x=>x.id==e.target.dataset.id);
        detailTitle.textContent = w.title;
        detailDesc .textContent = w.description;
        detailList.innerHTML    = w.exercises.map(x=>`<li>${x}</li>`).join('');
        detailEquip.textContent = w.equipment;
        detailCal  .textContent = w.calories;
        detailModal.style.display='flex';

        btnLog.onclick = ()=>{
          const acts = Storage.get('ft_activities', []);
          acts.unshift({ date:new Date().toISOString().slice(0,10),
            type:w.title,category:w.category,duration:w.duration,
            distance:'',calories:w.calories,notes:''});
          Storage.set('ft_activities',acts);
          detailModal.style.display='none';
        };
        btnSavePlan.onclick = ()=>{
          const plans=Storage.get('ft_plans',[]);
          if(!plans.includes(w.id)) plans.push(w.id);
          Storage.set('ft_plans',plans);
          detailModal.style.display='none';
        };
      }
    });

    // MY PLANS
    function renderPlans(){
      const p=Storage.get('ft_plans',[]);
      plansList.innerHTML='';
      p.forEach((id,i)=>{
        const w=workouts.find(x=>x.id===id),
              li=document.createElement('li');
        li.innerHTML=`${w.title} <button data-remove="${i}">Remove</button>`;
        plansList.append(li);
      });
    }
    plansList.onclick=e=>{
      if(e.target.dataset.remove!=null){
        const idx=+e.target.dataset.remove,arr=Storage.get('ft_plans',[]);
        arr.splice(idx,1);Storage.set('ft_plans',arr);
      }
    };

    // PROGRESS CHART
    let chart;
    function renderProgress(){
      const acts=Storage.get('ft_activities',[]),
            byCat=acts.reduce((o,a)=>{
              const w=workouts.find(wk=>wk.title===a.type),
                    c=w? w.category:'Other';
              o[c]=(o[c]||0)+1;return o;
            },{}),
            labels=Object.keys(byCat),data=Object.values(byCat);
      if(chart) chart.destroy();
      chart=new Chart(ctx,{
        type:'line',
        data:{labels,datasets:[{data,borderColor:var(--gold),fill:false,tension:0.3}]},
        options:{responsive:true,plugins:{legend:{display:false}},
          scales:{x:{ticks:{color:'#fff'}},y:{beginAtZero:true,ticks:{color:'#fff'}}}}
      });
    }

    // CHALLENGE MODES (with restartable progress)
    const CH_KEY='ft_challenges';
    if(!Storage.get(CH_KEY)) Storage.set(CH_KEY,{});
    function renderChallenges(){
      const progObj=Storage.get(CH_KEY,{}),acts=Storage.get('ft_activities',[]);
      chList.innerHTML='';
      challenges.forEach(ch=>{
        const rec=progObj[ch.id],
              start=new Date(rec?rec.startDate:0),
              count=acts.filter(a=>
                a.category===ch.matchCategory && new Date(a.date)>=start
              ).length,
              pct=Math.min(100,Math.round(count/ch.target*100)),
              joined=!!rec;
        const div=document.createElement('div');div.className='challenge';
        div.innerHTML=`
          <h3>${ch.title}</h3>
          <p>${ch.desc}</p>
          <div class="prog-bar"><div class="fill" style="width:${pct}%"></div></div>
          <p style="opacity:.8">${count} / ${ch.target} complete (${pct}%)</p>
          <button class="join">${joined?'Joined ✓':'Join Challenge'}</button>
          ${ joined ? '<button class="restart">Restart</button>' : ''}`;
        // join
        div.querySelector('.join').onclick=()=>{
          progObj[ch.id]={startDate:new Date().toISOString()};
          Storage.set(CH_KEY,progObj);renderChallenges();
        };
        // restart
        const rBtn=div.querySelector('.restart');
        if(rBtn) rBtn.onclick=()=>{
          progObj[ch.id]={startDate:new Date().toISOString()};
          Storage.set(CH_KEY,progObj);renderChallenges();
        };
        chList.append(div);
      });
    }

    // LIVE SESSIONS
    const SESS_KEY='ft_liveSessions',SCH_KEY='ft_mySchedules';
    const seed=[
      {id:1,img:'sunrise.jpg',title:'Sunrise Yoga',host:'Alice',date:Date.now()+3600000,desc:'Vinyasa flow.'},
      {id:2,img:'hiitblast.jpg',title:'HIIT Blast',host:'Bob',date:Date.now()+7200000,desc:'Intervals.'},
      {id:3,img:'dance.jpg',title:'Cardio Dance',host:'Cara',date:Date.now()-1800000,desc:'Dance cardio.'},
      {id:4,img:'core.jpg',title:'Core & Balance',host:'Dan',date:Date.now()+10800000,desc:'Stability drills.'},
      {id:5,img:'posture.jpg',title:'Pilates Power',host:'Eve',date:Date.now()+14400000,desc:'Core & posture.'}
    ];
    if(!Storage.get(SESS_KEY,[]).length) Storage.set(SESS_KEY,seed);
    function renderSessions(){
      const sessions=Storage.get(SESS_KEY,[]),joined=Storage.get(SCH_KEY,[]),now=Date.now();
      sessList.innerHTML='';
      sessions.forEach(s=>{
        const isLive=now>=s.date&&now<s.date+3600000,
              isFuture=now<s.date,hasJoined=joined.includes(s.id),
              btnTxt=isLive?'🔴 LIVE':(hasJoined?'✔ Scheduled':'⏱ Schedule'),
              card=document.createElement('div');card.className='live-card';
        card.innerHTML=`
          ${isLive?'<div class="status">LIVE</div>':''}
          <img src="${s.img}" alt="${s.title}">
          <h3>${s.title}</h3>
          <p class="info">${s.host} • ${new Date(s.date).toLocaleString()}</p>
          <p class="desc">${s.desc}</p>
          <button data-id="${s.id}">${btnTxt}</button>`;
        card.querySelector('button').onclick=()=>{
          if(isFuture&&!hasJoined){
            joined.push(s.id);Storage.set(SCH_KEY,joined);renderSessions();
          }
          if(isLive) goLiveModal.style.display='flex';
        };
        sessList.append(card);
      });
    }

    // MASTER RENDER
    function syncAll(){
      renderFeatured();
      renderCategories();
      renderAllWorkouts();
      renderPlans();
      renderProgress();
      renderChallenges();
      renderSessions();
    }
    syncAll();

    // WATCH STORAGE
    ['ft_activities','ft_plans','ft_mySchedules',CH_KEY,SESS_KEY]
      .forEach(k=>Storage.onChange(k,syncAll));
  });
  </script>
</body>
</html>
