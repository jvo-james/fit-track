<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FitTrack | Workouts</title>

  <!-- Google Fonts & FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <script defer src="https://kit.fontawesome.com/a2e8f1b6b1.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Chart.js & storage helper -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="storage.js"></script>

  <style>
    :root {
      --bg: #000;
      --gold: #ff9800;
      --white: #fff;
      --accent: rgba(255,255,255,0.05);
      --font-base: 'Raleway', sans-serif;
      --font-head: 'Poppins', sans-serif;
      --sidebar-w: 80px;
      --mobile-w: 200px;
      --transition: .3s;
    }
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    body {
      display:flex; min-height:100vh;
      background:var(--bg); color:var(--white);
      font-family:var(--font-base); overflow-x:hidden;
    }
    a { color:inherit; text-decoration:none; }
    button, select, input, textarea { font-family:var(--font-head); }
    button, select { background:var(--gold); color:var(--bg); border:none; border-radius:30px; padding:.6rem 1rem; cursor:pointer; transition:var(--transition); }
    input, textarea { background:var(--accent); border:1px solid var(--accent); border-radius:6px; padding:.6rem; color:var(--white); }
    button:hover, select:hover { transform:scale(1.03); }

    /* overlay */
    #overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); visibility:hidden; opacity:0; transition:var(--transition); z-index:100; }
    #overlay.active { visibility:visible; opacity:1; }

    /* SIDEBAR */
    .sidebar {
      width:var(--sidebar-w); background:rgba(0,0,0,0.9);
      border-right:2px solid var(--gold);
      display:flex; flex-direction:column; align-items:center;
      padding:1rem 0; position:sticky; top:0; height:100vh; z-index:200;
      transition:left var(--transition);
    }
    .sidebar .logo { font-size:1.8rem; color:var(--gold); margin-bottom:2rem; }
    .sidebar a.menu-item, .sidebar button.profile-menu {
      width:100%; padding:.8rem 0;
      display:flex; flex-direction:column; align-items:center; gap:.3rem;
      color:var(--white); background:none; border:none; transition:var(--transition);
    }
    .sidebar a.menu-item.active,
    .sidebar a.menu-item:hover,
    .sidebar button.profile-menu:hover {
      background:rgba(255,152,0,0.2);
    }
    .sidebar a.menu-item i, .sidebar button.profile-menu i.avatar { font-size:1.4rem; }
    .sidebar a.menu-item span, .sidebar button.profile-menu span { font-size:.75rem; }
    .sidebar a.sign-out { margin-top:auto; margin-bottom:1rem; }

    /* MOBILE SIDEBAR */
    @media (max-width:600px) {
      .sidebar {
        position:fixed; left:-100%; width:var(--mobile-w); height:100vh;
      }
      .sidebar.open { left:0; }
    }

    /* MAIN & HEADER */
    .main { flex:1; display:flex; flex-direction:column; margin-left:var(--sidebar-w); }
    @media(max-width:600px){ .main { margin-left:0; } }
    header {
      display:flex; align-items:center; justify-content:space-between;
      padding:1rem; background:rgba(0,0,0,0.9); border-bottom:2px solid var(--gold);
      position:sticky; top:0; z-index:150;
    }
    .hamburger {
      display:none; background:none; border:none; color:var(--white); font-size:1.5rem; cursor:pointer;
    }
    @media(max-width:600px){ .hamburger { display:inline-flex; } }
    .logo-header { font-family:var(--font-head); font-size:1.4rem; color:var(--gold); }
    #profile-btn { background:none; border:none; color:var(--white); font-size:1.5rem; }

    /* Welcome banner */
    #welcomeBanner { background:rgba(255,152,0,0.1); color:var(--white); text-align:center; padding:.75rem; }

    /* CONTENT GRID */
    .content { flex:1; overflow-y:auto; padding:1.5rem; display:grid; grid-template-columns:1fr 1fr; gap:2rem; }
    @media(max-width:900px){ .content { grid-template-columns:1fr; } }

    /* Workout of the Day */
    #workoutOfDay {
      grid-column:1/-1; background:var(--accent); border-radius:12px; padding:1.5rem; box-shadow:0 4px 12px rgba(0,0,0,0.5);
    }
    #workoutOfDay h2 { color:var(--gold); margin-bottom:.5rem; display:flex; align-items:center; gap:.5rem; }
    #workoutOfDay button { margin-top:.75rem; }

    /* Filters */
    #filters { grid-column:1/-1; display:flex; flex-wrap:wrap; gap:1rem; }

    /* Featured Workouts */
    #featuredWorkouts { grid-column:1/-1; }
    #featuredWorkouts h2 { color:var(--gold); margin-bottom:1rem; display:flex; align-items:center; gap:.5rem; }
    .card-grid { display:grid; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); }
    .card {
      background:var(--accent); border-radius:12px; overflow:hidden;
      box-shadow:0 4px 12px rgba(0,0,0,0.5); display:flex; flex-direction:column; height:100%;
    }
    .card img { width:100%; height:140px; object-fit:cover; }
    .card-body { padding:1rem; flex:1; display:flex; flex-direction:column; }
    .card-body h3 { margin-bottom:.5rem; font-size:1.1rem; }
    .card-body p.info { opacity:.8; margin-bottom:.5rem; font-size:.9rem; }
    .card-body p.desc { flex:1; margin-bottom:.5rem; font-size:.9rem; }
    .card-body .rating { margin-bottom:.5rem; }
    .card-body button { margin-top:auto; }

    /* Library */
    #library { grid-column:1/-1; }
    #library h2 { color:var(--gold); margin-bottom:1rem; display:flex; align-items:center; gap:.5rem; }
    .library-intro { opacity:.8; font-style:italic; margin-bottom:1rem; }
    .library-search { display:flex; gap:.5rem; margin-bottom:1rem; }
    .library-search input { flex:1; }
    .library-search button { flex:none; }
    #libraryGrid .card-body .reviews { font-size:.85rem; margin-bottom:.5rem; }
    #libraryGrid .card-body .add-review { font-size:.85rem; background:transparent; border:1px solid var(--white); padding:.3rem .5rem; border-radius:6px; cursor:pointer; }

    /* Detail Modal */
    #detailModal {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8);
      align-items:center; justify-content:center; padding:1rem; z-index:250;
    }
    #detailModal .modal-content {
      background:var(--bg); border-radius:12px; padding:1.5rem; max-width:600px; width:100%; max-height:90%; overflow-y:auto; position:relative;
    }
    #detailModal .close { position:absolute; top:1rem; right:1rem; font-size:1.5rem; color:var(--gold); cursor:pointer; }

    /* My Plans, Progress, Challenges, Live Sessions omitted for brevity... reuse previous styles */

    /* Chatbot */
    #chatbot {
      position:fixed; bottom:20px; right:20px; width:320px; max-height:420px;
      background:#fff; color:#222; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,0.15);
      display:none; flex-direction:column; overflow:hidden; font-family:'Poppins',sans-serif; z-index:300;
    }
    #chatbot header {
      padding:.75rem; background:#f5f5f5; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #ddd;
    }
    #chatbot .messages { flex:1; overflow-y:auto; padding:1rem; }
    #chatbot .msg { margin-bottom:.6rem; padding:.6rem .8rem; border-radius:12px; max-width:75%; word-break:break-word; }
    #chatbot .user { align-self:flex-end; background:#e8e8e8; color:#111; }
    #chatbot .bot  { align-self:flex-start; background:#f1f1f1; border:1px solid #ececec; }
    #chatbot .input { display:flex; border-top:1px solid #ddd; padding:.5rem; gap:.5rem; }
    #chatbot .input input { flex:1; border-radius:8px; }
    #chatbot .input button { border-radius:8px; }
    #chatToggle {
      position:fixed; bottom:20px; right:20px; width:50px; height:50px;
      background:#fff; color:#222; border:none; border-radius:50%; font-size:1.4rem;
      box-shadow:0 0 8px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:200;
    }
  </style>
</head>
<body>
  <div id="overlay"></div>
  <aside id="sidebar" class="sidebar">
    <button id="sidebar-close" class="sidebar-close">&times;</button>
    <div class="logo"><i class="fas fa-heartbeat"></i></div>
    <a href="dashboard.html" class="menu-item"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
    <a href="log.html" class="menu-item"><i class="fas fa-pen"></i><span>Log</span></a>
    <a href="workouts.html" class="menu-item active"><i class="fas fa-dumbbell"></i><span>Workouts</span></a>
    <a href="leaderboard.html" class="menu-item"><i class="fas fa-trophy"></i><span>Board</span></a>
    <button class="menu-item profile-menu"><i id="side-avatar" class="fas fa-user-circle avatar"></i><span>Profile</span></button>
    <a href="home.html" class="menu-item sign-out"><i class="fas fa-sign-out-alt"></i><span>Sign Out</span></a>
  </aside>

  <div class="main">
    <header>
      <button id="hamburger" class="hamburger"><i class="fas fa-bars"></i></button>
      <div class="logo-header"><i class="fas fa-dumbbell"></i> Workouts</div>
      <button id="profile-btn"><i id="top-avatar" class="fas fa-user-circle avatar"></i></button>
    </header>

    <div id="welcomeBanner">Welcome back!</div>

    <div class="content">
      <!-- Workout of the Day -->
      <section id="workoutOfDay">
        <h2><i class="fas fa-star"></i> Workout of the Day</h2>
        <p id="wodTitle">Loading‚Ä¶</p>
        <p id="wodDesc"></p>
        <button id="randomizeWOD">Randomize</button>
      </section>

      <!-- Filters -->
      <div id="filters">
        <select id="filterCategory"><option value="">All Categories</option></select>
        <select id="filterDuration">
          <option value="">Any Duration</option>
          <option value="20">Under 20 m</option>
          <option value="45">Under 45 m</option>
          <option value="999">45 m +</option>
        </select>
        <select id="filterDifficulty">
          <option value="">Any Difficulty</option>
          <option>Beginner</option>
          <option>Intermediate</option>
          <option>Advanced</option>
        </select>
      </div>

      <!-- Featured Workouts -->
      <section id="featuredWorkouts">
        <h2><i class="fas fa-fire"></i> Featured Workouts</h2>
        <div class="card-grid" id="featuredList"></div>
      </section>

      <!-- Library -->
      <section id="library">
        <h2><i class="fas fa-book-open"></i> Browse Library</h2>
        <p class="library-intro">üîç Search 100+ workouts and add reviews. Your feedback is saved globally.</p>
        <div class="library-search">
          <input type="text" id="libSearchInput" placeholder="Search workouts‚Ä¶"/>
          <button id="libSearchBtn">Go</button>
        </div>
        <div class="card-grid" id="libraryGrid"></div>
      </section>

      <!-- Detail Modal -->
      <div id="detailModal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2 id="detailTitle"></h2>
          <p id="detailDesc"></p>
          <ul id="detailList"></ul>
          <p><strong>Equipment:</strong> <span id="detailEquip"></span></p>
          <p><strong>Calories:</strong> <span id="detailCal">0</span></p>
          <div style="margin-top:1rem; display:flex; gap:1rem;">
            <button id="detailStart">Log This Workout</button>
          </div>
        </div>
      </div>

      <!-- Chatbot -->
      <div id="chatbot">
        <header>
          <i class="fas fa-comments"></i> Chat Coach
          <button class="close-btn" id="chatClose">&times;</button>
        </header>
        <div class="messages" id="chatMessages"><div class="msg bot">Hi! Ask me anything.</div></div>
        <div class="input">
          <input type="text" id="chatInput" placeholder="Type your question‚Ä¶"/>
          <button id="askBtn"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
      <button id="chatToggle"><i class="fas fa-comments"></i></button>
    </div>
  </div>

  <script type="module">
    import { Storage } from './storage.js';

    document.addEventListener('DOMContentLoaded', () => {
      // Redirect if not signed in
      const cur = Storage.get('ft_current', {});
      if (!cur.name) return location.replace('home.html');

      // Sidebar toggle
      const sidebar = document.getElementById('sidebar'),
            overlay = document.getElementById('overlay'),
            openBtn = document.getElementById('hamburger'),
            closeBtn = document.getElementById('sidebar-close');
      openBtn.onclick = ()=>{ sidebar.classList.add('open'); overlay.classList.add('active'); };
      closeBtn.onclick = ()=>{ sidebar.classList.remove('open'); overlay.classList.remove('active'); };
      overlay.onclick = ()=>{ sidebar.classList.remove('open'); overlay.classList.remove('active'); };

      // Avatar swap
      function updateAvatars(){
        const prof = Storage.get('ft_current', {});
        ['side-avatar','top-avatar'].forEach(id=>{
          const el = document.getElementById(id);
          if (!el) return;
          const img = document.createElement('img');
          img.id = id; img.className = 'avatar';
          img.src = prof.avatarDataUrl || `https://i.pravatar.cc/150?u=${prof.email}`;
          el.replaceWith(img);
        });
      }
      updateAvatars();
      Storage.onChange('ft_current', updateAvatars);

      // Workouts data
      const workouts = [
        { id:1,title:'Full-Body HIIT',category:'Cardio',duration:20,difficulty:'Intermediate',image:'hiit.jpg',description:'Fast-paced intervals.' },
        { id:2,title:'Upper Body Strength',category:'Strength',duration:45,difficulty:'Advanced',image:'upper.jpg',description:'Build power.' },
        { id:3,title:'Morning Yoga Flow',category:'Yoga',duration:30,difficulty:'Beginner',image:'yoga.jpg',description:'Gentle wake-up.' },
        { id:4,title:'Tabata Burn',category:'Cardio',duration:15,difficulty:'Advanced',image:'tabata.jpg',description:'High-intensity Tabata.' },
        { id:5,title:'Lower Body Blast',category:'Strength',duration:40,difficulty:'Intermediate',image:'lower.jpg',description:'Squats & lunges.' },
        { id:6,title:'Core Crusher',category:'Core',duration:25,difficulty:'Intermediate',image:'abs.jpg',description:'Abs & obliques.' },
        { id:7,title:'Pilates Power',category:'Pilates',duration:35,difficulty:'Beginner',image:'pilate.jpg',description:'Full-body Pilates.' },
        { id:8,title:'Kickboxing Cardio',category:'Cardio',duration:30,difficulty:'Advanced',image:'bag.jpg',description:'Punch & kick combos.' },
        { id:9,title:'Endurance Run',category:'Cardio',duration:60,difficulty:'Advanced',image:'run.jpg',description:'Steady long run.' },
        { id:10,title:'Zen Stretch',category:'Flexibility',duration:15,difficulty:'Beginner',image:'stretch.jpg',description:'Relaxing stretches.' }
      ];

      // WOD
      const wodTitle = document.getElementById('wodTitle'),
            wodDesc  = document.getElementById('wodDesc'),
            rndBtn   = document.getElementById('randomizeWOD');
      function pickWOD(){ const w=workouts[Math.floor(Math.random()*workouts.length)]; wodTitle.textContent=w.title; wodDesc.textContent=w.description; }
      rndBtn.onclick=pickWOD; pickWOD();

      // Featured Workouts
      const featuredList = document.getElementById('featuredList');
      function renderFeatured(){
        featuredList.innerHTML='';
        workouts.slice(0,10).forEach(w=>{
          const card=document.createElement('div');card.className='card';
          card.innerHTML=`
            <img src="${w.image}" alt="${w.title}">
            <div class="card-body">
              <h3>${w.title}</h3>
              <p class="info">${w.category} ‚Ä¢ ${w.duration}m ‚Ä¢ ${w.difficulty}</p>
              <p class="desc">${w.description}</p>
              <button data-id="${w.id}">Details</button>
            </div>`;
          featuredList.appendChild(card);
        });
      }

      // Reviews storage
      function getReviews(id){
        const all = Storage.get('reviews', {});
        return all[id]||[];
      }
      function saveReview(id,text){
        const all = Storage.get('reviews', {});
        (all[id] = all[id]||[]).push(text);
        Storage.set('reviews', all);
      }

      // Library & Filters
      const libraryGrid = document.getElementById('libraryGrid'),
            catSel = document.getElementById('filterCategory'),
            durSel = document.getElementById('filterDuration'),
            difSel = document.getElementById('filterDifficulty'),
            libSearchInput = document.getElementById('libSearchInput'),
            libSearchBtn = document.getElementById('libSearchBtn');

      // populate category
      Array.from(new Set(workouts.map(w=>w.category))).forEach(c=>catSel.add(new Option(c,c)));

      function renderLibraryItem(w){
        const reviews = getReviews(w.id);
        const avg = reviews.length ? (reviews.reduce((a,b)=>a+(b.length),0)/reviews.length).toFixed(1) : '‚Äì';
        const card=document.createElement('div');card.className='card';
        card.innerHTML=`
          <img src="${w.image}" alt="${w.title}">
          <div class="card-body">
            <h3>${w.title}</h3>
            <p class="info">üè∑Ô∏è ${w.category} ‚Ä¢ ‚è±Ô∏è ${w.duration} min ‚Ä¢ üî• ${w.difficulty}</p>
            <p class="desc">${w.description.slice(0,80)}‚Ä¶</p>
            <p class="reviews">Reviews: ${reviews.length} | Avg length: ${avg}</p>
            <button class="add-review" data-id="${w.id}">Add Review</button>
            <button data-id="${w.id}">Details</button>
          </div>`;
        libraryGrid.appendChild(card);
      }
      function renderLibrary(){
        const term=libSearchInput.value.trim().toLowerCase(),
              cat=catSel.value, max=+durSel.value||Infinity, diff=difSel.value;
        libraryGrid.innerHTML='';
        workouts.filter(w=>{
          return (!term||w.title.toLowerCase().includes(term)||w.category.toLowerCase().includes(term))
            &&(!cat||w.category===cat)
            &&w.duration<=max
            &&(!diff||w.difficulty===diff);
        }).forEach(renderLibraryItem);
      }
      libSearchBtn.onclick=renderLibrary;
      [catSel,durSel,difSel].forEach(el=>el.onchange=renderLibrary);
      renderLibrary();

      // Detail Modal
      const detailModal=document.getElementById('detailModal'),
            detailClose=detailModal.querySelector('.close'),
            detailTitle=document.getElementById('detailTitle'),
            detailDesc=document.getElementById('detailDesc'),
            detailList=document.getElementById('detailList'),
            detailEquip=document.getElementById('detailEquip'),
            detailCal=document.getElementById('detailCal'),
            btnLog=document.getElementById('detailStart');
      detailClose.onclick=()=>detailModal.style.display='none';
      document.body.addEventListener('click',e=>{
        if(e.target.classList.contains('add-review')){
          const id=e.target.dataset.id;
          const text=prompt('Enter your review:');
          if(text) saveReview(id,text),renderLibrary();
        }
        if(e.target.tagName==='BUTTON'&&e.target.dataset.id&&!e.target.classList.contains('add-review')){
          const w=workouts.find(x=>x.id==e.target.dataset.id);
          detailTitle.textContent=w.title;
          detailDesc.textContent=w.description;
          detailList.innerHTML=w.exercises.map(x=>`<li>${x}</li>`).join('');
          detailModal.style.display='flex';
          btnLog.onclick=()=>{
            const acts=Storage.get('ft_activities',[]);
            acts.unshift({ date:new Date().toISOString().slice(0,10), type:w.title, category:w.category, duration:w.duration, distance:'', calories:'', notes:'' });
            Storage.set('ft_activities',acts);
            detailModal.style.display='none';
          };
        }
      });

      // Chatbot
      const chatBox=document.getElementById('chatbot'),
            chatToggle=document.getElementById('chatToggle'),
            chatClose=document.getElementById('chatClose'),
            chatMessages=document.getElementById('chatMessages'),
            chatInput=document.getElementById('chatInput'),
            askBtn=document.getElementById('askBtn');
      const possible = [
        "What's today's workout?",
        "How do I log a session?",
        "How to save a plan?",
        "How to add a review?",
        "How many workouts have I done?",
        "Show me my top workouts",
        "What challenges are active?",
        "How to join a challenge?",
        "What is the leaderboard?",
        "How to go live?",
        "How to end live session?",
        "How to view my plans?",
        "How to filter workouts?",
        "How to change difficulty?",
        "How to sort by duration?",
        "How to view library reviews?",
        "How do I sign out?",
        "How to edit my profile?",
        "What badges have I unlocked?",
        "How to contact support?"
      ];
      chatToggle.onclick=()=>{ chatBox.style.display='flex'; chatToggle.style.display='none'; };
      chatClose.onclick=()=>{ chatBox.style.display='none'; chatToggle.style.display='flex'; chatMessages.innerHTML=`<div class="msg bot">Hi! Ask me anything.</div>`; };
      askBtn.onclick=()=>{
        const text=chatInput.value.trim(); if(!text) return;
        chatMessages.innerHTML+=`<div class="msg user">${text}</div>`;
        // simple echo or canned response:
        const lower=text.toLowerCase();
        let resp="Sorry, I don't know that one.";
        if(lower.includes('workout')) resp="Hit 'Randomize' to see today's Workout of the Day.";
        else if(lower.includes('log')) resp="Click Details ‚Üí Log This Workout to record.";
        else if(lower.includes('review')) resp="Use 'Add Review' under Browse Library cards.";
        chatMessages.innerHTML+=`<div class="msg bot">${resp}</div>`;
        chatMessages.scrollTop=chatMessages.scrollHeight;
        chatInput.value='';
      };
      // Autocomplete suggestions
      chatInput.addEventListener('input',e=>{
        // could implement dropdown of `possible` matching e.target.value
      });

      // initial render calls
      renderFeatured();
    });
  </script>
</body>
</html>
