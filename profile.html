<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FitTrack | Profile</title>

  <!-- Google Fonts & FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
  :root {
    --bg: #0d0d0d;
    --fg: #fff;
    --accent: rgba(255,255,255,0.05);
    --input-bg: rgba(255,255,255,0.1);
    --gold: #ff9800;
    --font-base: 'Raleway', sans-serif;
    --font-head: 'Poppins', sans-serif;
  }
  *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
  body {
    display:flex; min-height:100vh;
    background:var(--bg); color:var(--fg);
    font-family:var(--font-base);
  }
  a { color:inherit; text-decoration:none; }

  /* Overlay (mobile sidebar) */
  #overlay {
    position:fixed; top:0; right:0; bottom:0; left:0;
    background:rgba(0,0,0,0.5);
    opacity:0; visibility:hidden; transition:opacity .3s;
    z-index:90;
  }
  #overlay.active { opacity:1; visibility:visible; }

  /* SIDEBAR */
  .sidebar {
    width:80px; background:rgba(0,0,0,0.9);
    border-right:2px solid var(--gold);
    display:flex; flex-direction:column; align-items:center;
    padding-top:1rem; position:sticky; top:0; height:100vh;
    transition:transform .3s ease;
    z-index:100;
  }
  @media(max-width:800px){
    .sidebar { position:fixed; transform:translateX(-100%); }
    .sidebar.open { transform:translateX(0); }
  }
  .sidebar .logo { font-size:1.8rem; color:var(--gold); margin-bottom:2rem; }
  .sidebar a, .sidebar button {
    width:100%; margin-bottom:1rem;
    background:none; border:none; color:var(--fg);
    display:flex; flex-direction:column; align-items:center;
    font-family:var(--font-head); font-size:.75rem;
    transition:background .3s;
  }
  .sidebar a:hover, .sidebar button:hover { background:var(--accent); }
  .sidebar i.avatar { font-size:2rem; margin-bottom:.25rem; }
  .sidebar a.sign-out { margin-top:auto; margin-bottom:1rem; }

  /* Main & Header */
  .main { flex:1; display:flex; flex-direction:column; }
  header {
    display:flex; align-items:center; justify-content:space-between;
    padding:1rem; background:rgba(0,0,0,0.9);
    border-bottom:2px solid var(--gold);
    position:sticky; top:0; z-index:80;
  }
  .hamburger { display:none; font-size:1.5rem; background:none; border:none; color:var(--fg); }
  @media(max-width:800px){ .hamburger { display:block; } }
  header h1 { font-family:var(--font-head); font-size:1.5rem; color:var(--gold); }
  .header-controls { display:flex; align-items:center; gap:1rem; }
  .header-controls button {
    background:none; border:none; color:var(--fg); font-size:1.4rem; cursor:pointer;
  }

  /* Profile Form */
  .container { flex:1; overflow-y:auto; padding:1rem; }
  .profile-panel { max-width:900px; margin:0 auto; }
  #profileForm {
    display:grid; grid-template-columns:1fr 2fr; gap:1.5rem;
    background:var(--accent); padding:1.5rem; border-radius:12px;
  }
  @media(max-width:600px){ #profileForm { grid-template-columns:1fr; } }
  .avatar-section {
    display:flex; flex-direction:column; align-items:center; gap:1rem;
  }
  #avatarPreview {
    width:140px; height:140px; border-radius:50%;
    background:var(--input-bg); display:flex; align-items:center; justify-content:center;
    font-size:3rem; color:rgba(255,255,255,0.5); overflow:hidden;
  }
  .avatar-buttons button {
    background:var(--gold); color:var(--bg); border:none;
    padding:.5rem 1rem; border-radius:6px; cursor:pointer;
    font-family:var(--font-head);
  }
  .fields { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
  @media(max-width:600px){ .fields { grid-template-columns:1fr; } }
  .field { display:flex; flex-direction:column; }
  .field label {
    margin-bottom:.3rem; font-family:var(--font-head); font-weight:600;
  }
  .field input, .field select, .field textarea {
    padding:.6rem; border:none; border-radius:6px;
    background:var(--input-bg); color:var(--fg);
    font-size:1rem;
  }
  .field textarea { min-height:80px; resize:vertical; }

  .completion-container {
    grid-column:1/-1; margin-top:1rem;
  }
  .completion-bar {
    height:12px; background:rgba(255,255,255,0.2); border-radius:6px; overflow:hidden;
  }
  #completionFill {
    height:100%; width:0; background:var(--gold); transition:width .5s ease;
  }

  .actions {
    grid-column:1/-1; display:flex; justify-content:flex-end; margin-top:1rem;
  }
  .actions button {
    background:var(--gold); color:var(--bg); border:none;
    padding:.6rem 1.2rem; border-radius:30px; cursor:pointer;
    font-family:var(--font-head); font-weight:600;
  }

  /* Extra Sections */
  .extras {
    margin-top:1.5rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem;
  }
  @media(max-width:600px){ .extras { grid-template-columns:1fr; } }
  .card {
    background:var(--accent); border-radius:8px; padding:1rem;
  }
  .card h3 { margin-bottom:.5rem; color:var(--gold); font-family:var(--font-head);}
  .badges { display:flex; flex-wrap:wrap; gap:.5rem; }
  .badges .badge {
    background:var(--gold); color:var(--bg);
    padding:.3rem .6rem; border-radius:12px;
    font-size:.75rem;
  }
  .activity-list { list-style:none; }
  .activity-list li { margin-bottom:.4rem; display:flex; justify-content:space-between; }
  .social-links button {
    background:none; border:none; color:var(--fg); font-size:1.4rem; margin-right:1rem; cursor:pointer;
  }

  /* Profile Summary */
  #profileSummary {
    margin-top:1.5rem; background:var(--accent); border-radius:8px; padding:1rem;
  }
  #profileSummary h2 { color:var(--gold); margin-bottom:.5rem; font-family:var(--font-head);}
  #profileSummary ul { list-style:none; }
  #profileSummary li { margin-bottom:.4rem; }

  </style>
</head>
<body>

  <div id="overlay" onclick="toggleSidebar()"></div>
  <aside class="sidebar" id="sidebar">
    <div class="logo"><i class="fas fa-heartbeat"></i></div>
    <button class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i><span>Dash</span></a>
    <a href="log.html"><i class="fas fa-pen"></i><span>Log</span></a>
    <a href="workouts.html"><i class="fas fa-dumbbell"></i><span>Workouts</span></a>
    <a href="leaderboard.html"><i class="fas fa-trophy"></i><span>Board</span></a>
    <button id="profileBtn" class="profile-menu"><i id="sideAvatar" class="fas fa-user-circle avatar-small"></i><span>Profile</span></button>
    <a href="signout.html" class="sign-out"><i class="fas fa-sign-out-alt"></i><span>Sign Out</span></a>
  </aside>

  <div class="main">
    <header>
      <h1>My Profile</h1>
      <div class="header-controls">
        <button id="logoutBtn" title="Sign Out"><i class="fas fa-sign-out-alt"></i></button>
        <button class="avatar-btn"><i id="hdrAvatarIcon" class="fas fa-user-circle avatar-small"></i></button>
      </div>
    </header>

    <div class="container">
      <div class="profile-panel">
        <form id="profileForm">
          <div class="avatar-section">
            <div id="avatarPreview"><i class="fas fa-user-circle"></i></div>
            <div class="avatar-buttons">
              <button type="button" id="changeAvatarBtn">Change</button>
              <button type="button" id="removeAvatarBtn">Remove</button>
            </div>
            <input type="file" id="avatarInput" accept="image/*" style="display:none;">
          </div>

          <div class="fields">
            <div class="field"><label>Full Name *</label><input id="fullName" type="text" required></div>
            <div class="field"><label>Email</label><input id="email" type="email" disabled></div>
            <div class="field"><label>Bio</label><textarea id="bio"></textarea></div>
            <div class="field"><label>Location</label><input id="location" type="text"></div>
            <div class="field"><label>Age</label><input id="age" type="number" min="0"></div>
            <div class="field"><label>Gender</label>
              <select id="gender">
                <option value="">Prefer not to say</option><option>Female</option><option>Male</option><option>Other</option>
              </select>
            </div>
            <div class="field"><label>Height (cm)</label><input id="height" type="number" min="0"></div>
            <div class="field"><label>Weight (kg)</label><input id="weight" type="number" min="0"></div>
            <div class="field"><label>Favorite Workout</label>
              <select id="favorite">
                <option>Running</option><option>Cycling</option><option>Swimming</option><option>HIIT</option><option>Yoga</option>
              </select>
            </div>
            <div class="field"><label>Goals</label><textarea id="goals"></textarea></div>

            <div class="completion-container">
              <label>Profile Completion:</label>
              <div class="completion-bar"><div id="completionFill"></div></div>
            </div>
          </div>

          <div class="actions">
            <button type="button" id="saveBtn">Save Changes</button>
          </div>
        </form>

        <!-- Extra interactive cards -->
        <div class="extras">
          <div class="card">
            <h3>Your Badges</h3>
            <div class="badges" id="badgeContainer">
              <!-- JS will inject badges -->
            </div>
          </div>
          <div class="card">
            <h3>Recent Activity</h3>
            <ul class="activity-list" id="activityList">
              <!-- JS will inject activities -->
            </ul>
          </div>
        </div>

        <!-- Profile Summary -->
        <div id="profileSummary">
          <h2>Your Profile Summary</h2>
          <ul>
            <li><strong>Name:</strong> <span id="sumName">—</span></li>
            <li><strong>Email:</strong> <span id="sumEmail">—</span></li>
            <li><strong>Bio:</strong> <span id="sumBio">—</span></li>
            <li><strong>Location:</strong> <span id="sumLocation">—</span></li>
            <li><strong>Age/Gender:</strong> <span id="sumAgeGender">—</span></li>
            <li><strong>Height/Weight:</strong> <span id="sumHW">—</span></li>
            <li><strong>Favorite:</strong> <span id="sumFavorite">—</span></li>
            <li><strong>Goals:</strong> <span id="sumGoals">—</span></li>
            <li><strong>Total Workouts:</strong> <span id="sumWorkouts">0</span></li>
            <li><strong>Total Distance:</strong> <span id="sumDistance">0 km</span></li>
            <li><strong>Total Calories:</strong> <span id="sumCalories">0</span></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- storage.js helper -->
  <script type="module" src="storage.js"></script>
  <script type="module">
    import { Storage } from './storage.js';

    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const changeBtn      = document.getElementById('changeAvatarBtn');
      const removeBtn      = document.getElementById('removeAvatarBtn');
      const avatarInput    = document.getElementById('avatarInput');
      const avatarPreview  = document.getElementById('avatarPreview');
      const saveBtn        = document.getElementById('saveBtn');
      const logoutBtn      = document.getElementById('logoutBtn');
      const completionFill = document.getElementById('completionFill');
      const badgeContainer = document.getElementById('badgeContainer');
      const activityList   = document.getElementById('activityList');
      const fields         = ['fullName','bio','location','age','gender','height','weight','favorite','goals'];
      const summaryEls     = {
        sumName:    'sumName',
        sumEmail:   'sumEmail',
        sumBio:     'sumBio',
        sumLocation:'sumLocation',
        sumAgeGender:'sumAgeGender',
        sumHW:      'sumHW',
        sumFavorite:'sumFavorite',
        sumGoals:   'sumGoals',
        sumWorkouts:'sumWorkouts',
        sumDistance:'sumDistance',
        sumCalories:'sumCalories'
      };

      // Helpers
      function updateAvatars() {
        const cur = Storage.get('ft_current', {}) || {};
        const url = cur.avatarDataUrl || '';
        ['sideAvatar','hdrAvatarIcon'].forEach(id => {
          const old = document.getElementById(id);
          if (!old) return;
          if (url) {
            const img = document.createElement('img');
            img.id = id; img.className = 'avatar-small'; img.src = url; img.alt = 'Avatar';
            old.replaceWith(img);
          } else {
            const icon = document.createElement('i');
            icon.id = id; icon.className = 'fas fa-user-circle avatar-small';
            old.replaceWith(icon);
          }
        });
      }

      function populateForm() {
        const cur = Storage.get('ft_current', {});
        fields.forEach(fld => {
          const el = document.getElementById(fld);
          el.value = cur[fld] || '';
        });
        if (cur.avatarDataUrl) {
          avatarPreview.style.backgroundImage = `url(${cur.avatarDataUrl})`;
          avatarPreview.innerHTML = '';
        } else {
          avatarPreview.style.backgroundImage = '';
          avatarPreview.innerHTML = '<i class="fas fa-user-circle"></i>';
        }
        updateCompletion();
        updateSummary();
        renderBadges();
        renderActivities();
      }

      function updateCompletion() {
        const cur = Storage.get('ft_current', {});
        let filled = 0;
        [...fields, 'avatarDataUrl'].forEach(k => { if (cur[k]) filled++; });
        completionFill.style.width = Math.round(filled/ (fields.length+1) *100) + '%';
      }

      function updateSummary() {
        const cur = Storage.get('ft_current', {});
        Object.entries(summaryEls).forEach(([key,id]) => {
          document.getElementById(id).textContent =
            key.startsWith('sumWork') || key==='sumCalories'
              ? Storage.get('ft_activities', []).length
              : (cur[id.replace('sum','').toLowerCase()] || '—');
        });
      }

      // Extra content
      function renderBadges() {
        const badges = Storage.get('ft_current', {}).badges || ['Welcome'];
        badgeContainer.innerHTML = badges.map(b => `<div class="badge">${b}</div>`).join('');
      }
      function renderActivities() {
        const acts = Storage.get('ft_activities', []).slice(-5).reverse();
        activityList.innerHTML = acts.map(a =>
          `<li>${new Date(a.date).toLocaleDateString()} — ${a.type} (${a.distance || 0} km)</li>`
        ).join('') || '<li>No recent activities</li>';
      }

      // Avatar handlers
      changeBtn.onclick = () => avatarInput.click();
      removeBtn.onclick = () => {
        const cur = Storage.get('ft_current', {}); delete cur.avatarDataUrl;
        Storage.set('ft_current', cur);
      };
      avatarInput.onchange = e => {
        const file = e.target.files[0]; if (!file) return;
        const r = new FileReader();
        r.onload = () => {
          const cur = Storage.get('ft_current', {});
          cur.avatarDataUrl = r.result;
          Storage.set('ft_current', cur);
        };
        r.readAsDataURL(file);
      };

      // Save & Logout
      saveBtn.onclick = () => {
        const cur = Storage.get('ft_current', {});
        const fn  = document.getElementById('fullName').value.trim();
        if (!fn) return alert('Full Name is required');
        fields.forEach(fld => cur[fld] = document.getElementById(fld).value);
        Storage.set('ft_current', cur);
        alert('Profile saved!');
      };
      logoutBtn.onclick = () => {
        Storage.set('ft_current', {});
        location.replace('home.html');
      };

      // React to changes
      Storage.onChange('ft_current', () => {
        populateForm();
        updateAvatars();
      });

      // Mobile sidebar
      document.querySelector('.hamburger').onclick = () => {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('active');
      };

      // Initial
      populateForm();
      updateAvatars();
    });
  </script>
</body>
</html>
