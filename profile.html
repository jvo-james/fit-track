<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FitTrack | Profile</title>

  <!-- Google Fonts & FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&amp;family=Poppins:wght@300;400;600&amp;display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    /* Existing variables & resets */
    :root {
      --bg: #0d0d0d;
      --fg: #fff;
      --accent: rgba(255,255,255,0.05);
      --input-bg: rgba(255,255,255,0.1);
      --gold: #ff9800;
      --font-base: 'Raleway', sans-serif;
      --font-head: 'Poppins', sans-serif;
      --sidebar-w: 80px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { display:flex; min-height:100vh; background:var(--bg); color:var(--fg); font-family:var(--font-base); }

    /* Overlay for mobile sidebar */
    #overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); opacity:0; visibility:hidden; transition:opacity .3s; z-index:90; }
    #overlay.active { opacity:1; visibility:visible; }

    /* Sidebar */
    .sidebar {
      width:var(--sidebar-w);
      background:rgba(0,0,0,0.9);
      border-right:2px solid var(--gold);
      display:flex; flex-direction:column; align-items:center;
      padding:1rem 0; position:sticky; top:0; height:100vh;
      transition:transform .3s ease; z-index:1000;
    }
    .sidebar.open { transform:translateX(0); }
    @media(max-width:800px){
      .sidebar { position:fixed; left:-100%; transform:translateX(-100%); }
    }
    .sidebar .logo { font-size:1.8rem; color:var(--gold); margin-bottom:2rem; }
    .sidebar button, .sidebar a { background:none; border:none; color:var(--fg); display:flex; flex-direction:column; align-items:center; gap:.25rem; margin-bottom:1.5rem; cursor:pointer; text-decoration:none; font-family:var(--font-head); font-size:.75rem; }
    .sidebar i.avatar { font-size:2.2rem; }
    .sidebar button:hover, .sidebar a:hover { background:var(--accent); border-radius:8px; }

    /* Main & header */
    .main { flex:1; display:flex; flex-direction:column; }
    header { background:rgba(0,0,0,0.9); padding:1rem; display:flex; align-items:center; justify-content:space-between; border-bottom:2px solid var(--gold); position:sticky; top:0; z-index:900; }
    .hamburger { display:none; background:none; border:none; color:var(--fg); font-size:1.5rem; }
    @media(max-width:800px){ .hamburger { display:block; } }
    header h1 { font-family:var(--font-head); font-size:1.4rem; color:var(--gold); }
    .header-controls { display:flex; align-items:center; gap:1rem; }
    .header-controls button { background:none; border:none; color:var(--fg); font-size:1.3rem; cursor:pointer; }

    /* Profile panel */
    .container { flex:1; overflow-y:auto; padding:1rem; }
    .profile-panel { max-width:900px; margin:0 auto; }

    /* Profile form */
    #profileForm { background:var(--accent); padding:1.5rem; border-radius:12px; display:grid; grid-template-columns:1fr 2fr; gap:1.5rem; }
    @media(max-width:600px){ #profileForm { grid-template-columns:1fr; } }
    .avatar-section { display:flex; flex-direction:column; align-items:center; gap:1rem; }
    #avatarPreview { width:130px; height:130px; border-radius:50%; background:var(--input-bg); display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,0.5); font-size:2.5rem; overflow:hidden; }
    .avatar-btns { display:flex; gap:.5rem; }
    .avatar-btns button { background:var(--gold); border:none; border-radius:6px; padding:.4rem .8rem; cursor:pointer; color:var(--bg); font-family:var(--font-head); }
    input[type=file] { display:none; }
    .fields { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    @media(max-width:600px){ .fields { grid-template-columns:1fr; } }
    .field { display:flex; flex-direction:column; }
    .field label { margin-bottom:.3rem; font-family:var(--font-head); font-weight:600; }
    .field input, .field select, .field textarea { background:var(--input-bg); border:none; border-radius:6px; padding:.6rem; color:var(--fg); }
    .field textarea { min-height:80px; resize:vertical; }
    .completion { grid-column:1/-1; margin-top:1rem; }
    .completion-bar { background:rgba(255,255,255,0.2); border-radius:6px; height:10px; overflow:hidden; }
    #completionFill { width:0; height:100%; background:var(--gold); transition:width .5s; }
    .actions { grid-column:1/-1; display:flex; justify-content:flex-end; margin-top:1rem; }
    .actions button { background:var(--gold); border:none; border-radius:30px; padding:.6rem 1.2rem; cursor:pointer; color:var(--bg); font-family:var(--font-head); font-weight:600; }

    /* Extras */
    .extras { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1.5rem; }
    @media(max-width:600px){ .extras { grid-template-columns:1fr; } }
    .card { background:var(--accent); border-radius:8px; padding:1rem; }
    .card h3 { font-family:var(--font-head); color:var(--gold); margin-bottom:.5rem; }
    .badges { display:flex; flex-wrap:wrap; gap:.5rem; }
    .badge { background:var(--gold); color:var(--bg); padding:.3rem .6rem; border-radius:12px; font-size:.75rem; }
    .activity-list { list-style:none; padding-left:0; }
    .activity-list li { display:flex; justify-content:space-between; margin-bottom:.4rem; }

    /* Summary */
    #profileSummary { background:var(--accent); border-radius:8px; padding:1rem; margin-top:1.5rem; }
    #profileSummary h2 { font-family:var(--font-head); color:var(--gold); margin-bottom:.5rem; }
    #profileSummary ul { list-style:none; }
    #profileSummary li { margin-bottom:.4rem; }

    /* Notifications Panel */
    #notifications {
      background:var(--accent); border-radius:8px; padding:1rem; margin-top:1.5rem;
    }
    #notifications h2 { font-family:var(--font-head); color:var(--gold); margin-bottom:.5rem; }
    .notif-item { display:flex; justify-content:space-between; padding:.5rem 0; border-bottom:1px solid rgba(255,255,255,0.1); }
    .notif-item:last-child { border-bottom:none; }

    /* Goals Tracker */
    #goalsTracker {
      display:flex; flex-wrap:wrap; gap:1rem; margin-top:1.5rem;
    }
    .goal-card {
      flex:1 1 calc(33% - 1rem);
      background:var(--accent); border-radius:8px; padding:1rem;
      min-width:200px;
    }
    .goal-card h4 { font-family:var(--font-head); color:var(--gold); margin-bottom:.5rem; }
    .progress-bar { background:rgba(255,255,255,0.2); border-radius:6px; height:8px; overflow:hidden; }
    .progress-fill { height:100%; background:var(--gold); width:0; transition:width .5s; }
  </style>
</head>
<body>

  <div id="overlay" onclick="toggleSidebar()"></div>
  <aside class="sidebar" id="sidebar">
    <div class="logo"><i class="fas fa-heartbeat"></i></div>
    <button class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <button id="profileBtn"><i id="sideAvatar" class="fas fa-user-circle avatar"></i><span>Profile</span></button>
    <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i><span>Dash</span></a>
    <a href="log.html"><i class="fas fa-pen"></i><span>Log</span></a>
    <a href="workouts.html"><i class="fas fa-dumbbell"></i><span>Workouts</span></a>
    <a href="leaderboard.html"><i class="fas fa-trophy"></i><span>Board</span></a>
    <a href="notifications.html"><i class="fas fa-bell"></i><span>Notifs</span></a>
    <a href="signout.html"><i class="fas fa-sign-out-alt"></i><span>Sign Out</span></a>
  </aside>

  <div class="main">
    <header>
      <h1>My Profile</h1>
      <div class="header-controls">
        <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
        <button><i id="hdrAvatarIcon" class="fas fa-user-circle avatar"></i></button>
      </div>
    </header>

    <div class="container">
      <div class="profile-panel">

        <!-- Profile Form -->
        <form id="profileForm">
          <div class="avatar-section">
            <div id="avatarPreview"><i class="fas fa-user-circle"></i></div>
            <div class="avatar-btns">
              <button type="button" id="changeAvatarBtn">Change</button>
              <button type="button" id="removeAvatarBtn">Remove</button>
            </div>
            <input type="file" id="avatarInput" accept="image/*">
          </div>
          <div class="fields">
            <!-- Full form fields here -->
            <div class="field"><label for="fullName">Full Name *</label><input id="fullName" type="text" required></div>
            <div class="field"><label for="email">Email</label><input id="email" type="email" disabled></div>
            <div class="field"><label for="bio">Bio</label><textarea id="bio"></textarea></div>
            <div class="field"><label for="location">Location</label><input id="location" type="text"></div>
            <div class="field"><label for="age">Age</label><input id="age" type="number" min="0"></div>
            <div class="field"><label for="gender">Gender</label>
              <select id="gender"><option value="">Prefer not to say</option><option>Female</option><option>Male</option><option>Other</option></select>
            </div>
            <div class="field"><label for="height">Height (cm)</label><input id="height" type="number" min="0"></div>
            <div class="field"><label for="weight">Weight (kg)</label><input id="weight" type="number" min="0"></div>
            <div class="field"><label for="favorite">Favorite Workout</label>
              <select id="favorite"><option>Running</option><option>Cycling</option><option>Swimming</option><option>HIIT</option><option>Yoga</option></select>
            </div>
            <div class="field"><label for="goals">Goals</label><textarea id="goals"></textarea></div>
            <div class="completion">
              <label>Profile Completion:</label>
              <div class="completion-bar"><div id="completionFill"></div></div>
            </div>
          </div>
          <div class="actions">
            <button type="button" id="saveBtn">Save Changes</button>
          </div>
        </form>

        <!-- Extras -->
        <div class="extras">
          <div class="card">
            <h3>Achievements</h3>
            <div class="badges" id="badgeContainer"></div>
          </div>
          <div class="card">
            <h3>Quick Settings</h3>
            <p><button style="background:var(--gold);border:none;padding:.4rem .8rem;border-radius:6px;cursor:pointer;color:var(--bg);">Change Password</button></p>
            <p><button style="background:var(--gold);border:none;padding:.4rem .8rem;border-radius:6px;cursor:pointer;color:var(--bg);">Privacy</button></p>
          </div>
        </div>

        <!-- Recent Activities -->
        <div id="notifications">
          <h2>Notifications</h2>
          <div class="notif-item"><span>New badge earned!</span><small>2h ago</small></div>
          <div class="notif-item"><span>Workout reminder</span><small>1d ago</small></div>
        </div>

        <!-- Goals Tracker -->
        <div id="goalsTracker">
          <div class="goal-card">
            <h4>30-day Run Challenge</h4>
            <div class="progress-bar"><div class="progress-fill" style="width:40%"></div></div>
            <small>12/30 days</small>
          </div>
          <div class="goal-card">
            <h4>Push-ups Streak</h4>
            <div class="progress-bar"><div class="progress-fill" style="width:70%"></div></div>
            <small>21/30 days</small>
          </div>
          <div class="goal-card">
            <h4>Yoga Routine</h4>
            <div class="progress-bar"><div class="progress-fill" style="width:15%"></div></div>
            <small>3/20 sessions</small>
          </div>
        </div>

        <!-- Summary -->
        <div id="profileSummary">
          <h2>Your Profile Summary</h2>
          <ul>
            <li><strong>Name:</strong> <span id="sumName">—</span></li>
            <li><strong>Email:</strong> <span id="sumEmail">—</span></li>
            <li><strong>Bio:</strong> <span id="sumBio">—</span></li>
            <li><strong>Location:</strong> <span id="sumLocation">—</span></li>
            <li><strong>Age/Gender:</strong> <span id="sumAgeGender">—</span></li>
            <li><strong>Height/Weight:</strong> <span id="sumHW">—</span></li>
            <li><strong>Favorite:</strong> <span id="sumFavorite">—</span></li>
            <li><strong>Goals:</strong> <span id="sumGoals">—</span></li>
            <li><strong>Total Workouts:</strong> <span id="sumWorkouts">0</span></li>
            <li><strong>Total Distance:</strong> <span id="sumDistance">0 km</span></li>
            <li><strong>Total Calories:</strong> <span id="sumCalories">0</span></li>
          </ul>
        </div>

      </div>
    </div>
  </div>

  <script type="module" src="storage.js"></script>
  <script type="module">
    import { Storage } from './storage.js';

    document.addEventListener('DOMContentLoaded', () => {
      /* Setup & helpers */
      const avatarInput    = document.getElementById('avatarInput');
      const avatarPreview  = document.getElementById('avatarPreview');
      const changeBtn      = document.getElementById('changeAvatarBtn');
      const removeBtn      = document.getElementById('removeAvatarBtn');
      const saveBtn        = document.getElementById('saveBtn');
      const logoutBtn      = document.getElementById('logoutBtn');
      const completionFill = document.getElementById('completionFill');
      const badgeContainer = document.getElementById('badgeContainer');
      const fields         = ['fullName','bio','location','age','gender','height','weight','favorite','goals'];
      const summaryMap     = {
        sumName:    u=>u.name||'—',
        sumEmail:   u=>u.email||'—',
        sumBio:     u=>u.bio||'—',
        sumLocation:u=>u.location||'—',
        sumAgeGender: u=>`${u.age||'—'}/${u.gender||'—'}`,
        sumHW:      u=>`${u.height||'—'} cm/${u.weight||'—'} kg`,
        sumFavorite:u=>u.favorite||'—',
        sumGoals:   u=>u.goals||'—',
        sumWorkouts:u=>Storage.get('ft_activities',[]).length,
        sumDistance:u=>Storage.get('ft_activities',[]).reduce((a,x)=>a+(+x.distance||0),0).toFixed(1)+' km',
        sumCalories:u=>Storage.get('ft_activities',[]).reduce((a,x)=>a+(+x.calories||0),0)
      };

      /* Sidebar toggle */
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      window.toggleSidebar = () => {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
      };

      /* Avatar sync */
      function updateAvatars(){
        const cur=Storage.get('ft_current',{})||{};
        const url=cur.avatarDataUrl||'';
        ['sideAvatar','hdrAvatarIcon'].forEach(id=>{
          const old=document.getElementById(id);
          if(!old) return;
          if(url){
            const img=document.createElement('img');
            img.id=id; img.className='avatar-small'; img.src=url; img.alt='Avatar';
            old.replaceWith(img);
          } else {
            const icon=document.createElement('i');
            icon.id=id; icon.className='fas fa-user-circle avatar-small';
            old.replaceWith(icon);
          }
        });
      }

      /* Populate form */
      function populate(){
        const cur=Storage.get('ft_current',{})||{};
        fields.forEach(f=>{
          const el=document.getElementById(f);
          if(el) el.value=cur[f]||'';
        });
        if(cur.avatarDataUrl){
          avatarPreview.style.backgroundImage=`url(${cur.avatarDataUrl})`;
          avatarPreview.innerHTML='';
        } else {
          avatarPreview.style.backgroundImage='';
          avatarPreview.innerHTML='<i class="fas fa-user-circle"></i>';
        }
        updateCompletion();
        updateSummary();
        renderBadges();
      }

      /* Completion bar */
      function updateCompletion(){
        const cur=Storage.get('ft_current',{})||{};
        let filled=0;
        [...fields,'avatarDataUrl'].forEach(k=>{ if(cur[k]) filled++; });
        completionFill.style.width=Math.round(filled/(fields.length+1)*100)+'%';
      }

      /* Summary */
      function updateSummary(){
        const cur=Storage.get('ft_current',{})||{};
        Object.entries(summaryMap).forEach(([id,fn])=>{
          document.getElementById(id).textContent=fn(cur);
        });
      }

      /* Badges */
      function renderBadges(){
        const badges=Storage.get('ft_current',{}).badges||['Welcome'];
        badgeContainer.innerHTML=badges.map(b=>`<div class="badge">${b}</div>`).join('');
      }

      /* Handlers */
      changeBtn.onclick=()=>avatarInput.click();
      removeBtn.onclick=()=>{
        const c=Storage.get('ft_current',{})||{};
        delete c.avatarDataUrl; Storage.set('ft_current',c);
      };
      avatarInput.onchange=e=>{
        const f=e.target.files[0];
        if(!f) return;
        const r=new FileReader();
        r.onload=()=>{
          const c=Storage.get('ft_current',{})||{};
          c.avatarDataUrl=r.result;
          Storage.set('ft_current',c);
        };
        r.readAsDataURL(f);
      };
      saveBtn.onclick=()=>{
        const cur=Storage.get('ft_current',{})||{};
        const name=document.getElementById('fullName').value.trim();
        if(!name) return alert('Full Name is required');
        cur.name=name; fields.slice(1).forEach(f=>cur[f]=document.getElementById(f).value);
        Storage.set('ft_current',cur);
        alert('Profile saved!');
      };
      logoutBtn.onclick=()=>{ Storage.set('ft_current',{}); location.replace('home.html'); };

      Storage.onChange('ft_current',()=>{
        populate();
        updateAvatars();
      });

      populate();
      updateAvatars();
    });
  </script>
</body>
</html>
