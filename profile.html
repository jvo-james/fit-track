<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FitTrack | Profile</title>

  <!-- Google Fonts & FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root {
      --bg: #0d0d0d;
      --fg: #fff;
      --accent: rgba(255,255,255,0.05);
      --input-bg: rgba(255,255,255,0.1);
      --gold: #ff9800;
      --font-base: 'Raleway', sans-serif;
      --font-head: 'Poppins', sans-serif;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { display:flex; min-height:100vh; background:var(--bg); color:var(--fg); font-family:var(--font-base); }
    a { color:inherit; text-decoration:none; }

    /* Sidebar */
    .sidebar {
      width:80px; background:rgba(0,0,0,0.9); border-right:2px solid var(--gold);
      display:flex; flex-direction:column; align-items:center; padding:1rem 0;
      position:sticky; top:0; height:100vh;
      transition:transform .3s ease;
      z-index:100;
    }
    .sidebar .logo { font-size:1.8rem; color:var(--gold); margin-bottom:2rem; }
    .sidebar button, .sidebar a {
      background:none; border:none; color:var(--fg);
      display:flex; flex-direction:column; align-items:center; gap:.25rem;
      margin-bottom:1.5rem; font-family:var(--font-head); font-size:.75rem; cursor:pointer;
    }
    .sidebar i.avatar { font-size:2rem; }
    .sidebar button:hover, .sidebar a:hover { background:var(--accent); border-radius:8px; }

    @media(max-width:800px){
      .sidebar { position:fixed; transform:translateX(-100%); }
      .sidebar.open { transform:translateX(0); }
    }

    /* Main & header */
    .main { flex:1; display:flex; flex-direction:column; }
    header {
      background:rgba(0,0,0,0.9); padding:1rem; display:flex; align-items:center; justify-content:space-between;
      border-bottom:2px solid var(--gold); position:sticky; top:0; z-index:90;
    }
    .hamburger { display:none; background:none; border:none; color:var(--fg); font-size:1.5rem; }
    @media(max-width:800px){ .hamburger { display:block; } }
    header h1 { font-family:var(--font-head); font-size:1.4rem; color:var(--gold); }
    .header-controls { display:flex; align-items:center; gap:1rem; }
    .header-controls button { background:none; border:none; color:var(--fg); font-size:1.3rem; cursor:pointer; }

    /* Form container */
    .container { flex:1; overflow-y:auto; padding:1rem; }
    .profile-panel { max-width:900px; margin:0 auto; }

    /* Profile form */
    #profileForm {
      background:var(--accent); padding:1.5rem; border-radius:12px;
      display:grid; grid-template-columns:1fr 2fr; gap:1.5rem;
    }
    @media(max-width:600px){ #profileForm { grid-template-columns:1fr; } }

    /* Avatar section */
    .avatar-section {
      display:flex; flex-direction:column; align-items:center; gap:1rem;
    }
    #avatarPreview {
      width:130px; height:130px; border-radius:50%;
      background:var(--input-bg); display:flex; align-items:center; justify-content:center;
      color:rgba(255,255,255,0.5); font-size:2.5rem; overflow:hidden;
    }
    .avatar-btns { display:flex; gap:.5rem; }
    .avatar-btns button {
      background:var(--gold); border:none; border-radius:6px;
      padding:.4rem .8rem; cursor:pointer; color:var(--bg); font-family:var(--font-head);
    }
    input[type=file] { display:none; }

    /* Fields */
    .fields { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    @media(max-width:600px){ .fields { grid-template-columns:1fr; } }
    .field { display:flex; flex-direction:column; }
    .field label {
      margin-bottom:.3rem; font-family:var(--font-head); font-weight:600;
    }
    .field input, .field select, .field textarea {
      background:var(--input-bg); border:none; border-radius:6px;
      padding:.6rem; color:var(--fg); font-size:1rem;
    }
    .field textarea { min-height:80px; resize:vertical; }

    /* Completion bar */
    .completion { grid-column:1/-1; margin-top:1rem; }
    .completion-bar {
      background:rgba(255,255,255,0.2); border-radius:6px; height:10px; overflow:hidden;
    }
    #completionFill { width:0; height:100%; background:var(--gold); transition:width .5s; }

    /* Actions */
    .actions { grid-column:1/-1; display:flex; justify-content:flex-end; margin-top:1rem; }
    .actions button {
      background:var(--gold); border:none; border-radius:30px;
      padding:.6rem 1.2rem; cursor:pointer; color:var(--bg);
      font-family:var(--font-head); font-weight:600;
    }

    /* Extras */
    .extras { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1.5rem; }
    @media(max-width:600px){ .extras { grid-template-columns:1fr; } }
    .card {
      background:var(--accent); border-radius:8px; padding:1rem;
    }
    .card h3 { font-family:var(--font-head); color:var(--gold); margin-bottom:.5rem; }
    .badges { display:flex; flex-wrap:wrap; gap:.5rem; }
    .badges .badge {
      background:var(--gold); color:var(--bg);
      padding:.3rem .6rem; border-radius:12px; font-size:.75rem;
    }
    .activity-list { list-style:none; padding-left:0; }
    .activity-list li { display:flex; justify-content:space-between; margin-bottom:.4rem; }

    /* Summary */
    #profileSummary { background:var(--accent); border-radius:8px; padding:1rem; margin-top:1.5rem; }
    #profileSummary h2 { font-family:var(--font-head); color:var(--gold); margin-bottom:.5rem; }
    #profileSummary ul { list-style:none; }
    #profileSummary li { margin-bottom:.4rem; }

  </style>
</head>
<body>

  <div id="overlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="logo"><i class="fas fa-heartbeat"></i></div>
    <button class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <button id="profileBtn"><i id="sideAvatar" class="fas fa-user-circle avatar"></i><span>Profile</span></button>
    <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i><span>Dash</span></a>
    <a href="log.html"><i class="fas fa-pen"></i><span>Log</span></a>
    <a href="workouts.html"><i class="fas fa-dumbbell"></i><span>Workouts</span></a>
    <a href="leaderboard.html"><i class="fas fa-trophy"></i><span>Board</span></a>
    <a href="signout.html" class="sign-out"><i class="fas fa-sign-out-alt"></i><span>Sign Out</span></a>
  </aside>

  <div class="main">
    <header>
      <h1>My Profile</h1>
      <div class="header-controls">
        <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
        <button><i id="hdrAvatarIcon" class="fas fa-user-circle avatar"></i></button>
      </div>
    </header>

    <div class="container">
      <div class="profile-panel">
        <form id="profileForm">
          <!-- Avatar -->
          <div class="avatar-section">
            <div id="avatarPreview"><i class="fas fa-user-circle"></i></div>
            <div class="avatar-btns">
              <button type="button" id="changeAvatarBtn">Change</button>
              <button type="button" id="removeAvatarBtn">Remove</button>
            </div>
            <input type="file" id="avatarInput" accept="image/*"/>
          </div>

          <!-- Fields -->
          <div class="fields">
            <div class="field"><label for="fullName">Full Name *</label><input id="fullName" type="text" required/></div>
            <div class="field"><label for="email">Email</label><input id="email" type="email" disabled/></div>
            <div class="field"><label for="bio">Bio</label><textarea id="bio"></textarea></div>
            <div class="field"><label for="location">Location</label><input id="location" type="text"/></div>
            <div class="field"><label for="age">Age</label><input id="age" type="number" min="0"/></div>
            <div class="field"><label for="gender">Gender</label>
              <select id="gender"><option value="">Prefer not to say</option><option>Female</option><option>Male</option><option>Other</option></select>
            </div>
            <div class="field"><label for="height">Height (cm)</label><input id="height" type="number" min="0"/></div>
            <div class="field"><label for="weight">Weight (kg)</label><input id="weight" type="number" min="0"/></div>
            <div class="field"><label for="favorite">Favorite Workout</label>
              <select id="favorite"><option>Running</option><option>Cycling</option><option>Swimming</option><option>HIIT</option><option>Yoga</option></select>
            </div>
            <div class="field"><label for="goals">Goals</label><textarea id="goals"></textarea></div>

            <!-- Completion bar -->
            <div class="completion">
              <label>Profile Completion:</label>
              <div class="completion-bar"><div id="completionFill"></div></div>
            </div>
          </div>

          <!-- Save -->
          <div class="actions">
            <button type="button" id="saveBtn">Save Changes</button>
          </div>
        </form>

        <!-- Extras -->
        <div class="extras">
          <div class="card">
            <h3>Your Badges</h3>
            <div class="badges" id="badgeContainer"></div>
          </div>
          <div class="card">
            <h3>Recent Activity</h3>
            <ul class="activity-list" id="activityList"></ul>
          </div>
        </div>

        <!-- Summary -->
        <div id="profileSummary">
          <h2>Your Profile Summary</h2>
          <ul>
            <li><strong>Name:</strong> <span id="sumName">—</span></li>
            <li><strong>Email:</strong> <span id="sumEmail">—</span></li>
            <li><strong>Bio:</strong> <span id="sumBio">—</span></li>
            <li><strong>Location:</strong> <span id="sumLocation">—</span></li>
            <li><strong>Age/Gender:</strong> <span id="sumAgeGender">—</span></li>
            <li><strong>Height/Weight:</strong> <span id="sumHW">—</span></li>
            <li><strong>Favorite:</strong> <span id="sumFavorite">—</span></li>
            <li><strong>Goals:</strong> <span id="sumGoals">—</span></li>
            <li><strong>Total Workouts:</strong> <span id="sumWorkouts">0</span></li>
            <li><strong>Total Distance:</strong> <span id="sumDistance">0 km</span></li>
            <li><strong>Total Calories:</strong> <span id="sumCalories">0</span></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- storage.js -->
  <script type="module" src="storage.js"></script>
  <script type="module">
    import { Storage } from './storage.js';
    document.addEventListener('DOMContentLoaded', ()=>{
      const avatarInput    = document.getElementById('avatarInput');
      const avatarPreview  = document.getElementById('avatarPreview');
      const changeBtn      = document.getElementById('changeAvatarBtn');
      const removeBtn      = document.getElementById('removeAvatarBtn');
      const saveBtn        = document.getElementById('saveBtn');
      const logoutBtn      = document.getElementById('logoutBtn');
      const completionFill = document.getElementById('completionFill');
      const badgeContainer = document.getElementById('badgeContainer');
      const activityList   = document.getElementById('activityList');
      const fields         = ['fullName','bio','location','age','gender','height','weight','favorite','goals'];
      const summaryIds     = ['sumName','sumEmail','sumBio','sumLocation','sumAgeGender','sumHW','sumFavorite','sumGoals','sumWorkouts','sumDistance','sumCalories'];

      // toggle sidebar
      window.toggleSidebar = ()=>{
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('active');
      };

      function updateAvatars(){
        const cur = Storage.get('ft_current',{})||{};
        const url = cur.avatarDataUrl||'';
        ['sideAvatar','hdrAvatarIcon'].forEach(id=>{
          const old = document.getElementById(id);
          if(!old) return;
          if(url){
            const img = document.createElement('img');
            img.id=id; img.className='avatar-small'; img.src=url; img.alt='Avatar';
            old.replaceWith(img);
          } else {
            const icon = document.createElement('i');
            icon.id=id; icon.className='fas fa-user-circle avatar-small';
            old.replaceWith(icon);
          }
        });
      }

      function populate(){
        const cur = Storage.get('ft_current',{})||{};
        fields.forEach(f=>{
          const el=document.getElementById(f);
          if(el) el.value=cur[f]||'';
        });
        // preview
        if(cur.avatarDataUrl){
          avatarPreview.style.backgroundImage=`url(${cur.avatarDataUrl})`;
          avatarPreview.innerHTML='';
        } else {
          avatarPreview.style.backgroundImage='';
          avatarPreview.innerHTML='<i class="fas fa-user-circle"></i>';
        }
        updateCompletion();
        updateSummary();
        renderBadges();
        renderActivities();
      }

      function updateCompletion(){
        const cur=Storage.get('ft_current',{})||{};
        let filled=0;
        [...fields,'avatarDataUrl'].forEach(k=>{if(cur[k])filled++;});
        completionFill.style.width=Math.round(filled/(fields.length+1)*100)+'%';
      }

      function updateSummary(){
        const cur=Storage.get('ft_current',{})||{};
        summaryIds.forEach((id,i)=>{
          let txt='—';
          switch(id){
            case 'sumName': txt=cur.name||'—'; break;
            case 'sumEmail': txt=cur.email||'—'; break;
            case 'sumBio': txt=cur.bio||'—'; break;
            case 'sumLocation': txt=cur.location||'—'; break;
            case 'sumAgeGender': txt=(cur.age||'—')+' / '+(cur.gender||'—'); break;
            case 'sumHW': txt=(cur.height||'—')+' cm / '+(cur.weight||'—')+' kg'; break;
            case 'sumWorkouts': txt=Storage.get('ft_activities',[]).length; break;
            case 'sumDistance': txt=Storage.get('ft_activities',[]).reduce((a,x)=>a+(+x.distance||0),0).toFixed(1)+' km'; break;
            case 'sumCalories': txt=Storage.get('ft_activities',[]).reduce((a,x)=>a+(+x.calories||0),0); break;
            case 'sumFavorite': txt=cur.favorite||'—'; break;
            case 'sumGoals': txt=cur.goals||'—'; break;
          }
          document.getElementById(id).textContent=txt;
        });
      }

      function renderBadges(){
        const badges = Storage.get('ft_current',{}).badges||['Welcome'];
        badgeContainer.innerHTML=badges.map(b=>`<div class="badge">${b}</div>`).join('');
      }
      function renderActivities(){
        const acts = Storage.get('ft_activities',[]).slice(-5).reverse();
        activityList.innerHTML=acts.map(a=>`<li>${new Date(a.date).toLocaleDateString()} — ${a.type} (${a.distance||0} km)</li>`).join('')||'<li>No recent activities</li>';
      }

      changeBtn.onclick = ()=>avatarInput.click();
      removeBtn.onclick = ()=>{
        const cur=Storage.get('ft_current',{})||{};
        delete cur.avatarDataUrl; Storage.set('ft_current',cur);
      };
      avatarInput.onchange = e=>{
        const file=e.target.files[0]; if(!file) return;
        const r=new FileReader();
        r.onload=()=>{ const cur=Storage.get('ft_current',{})||{}; cur.avatarDataUrl=r.result; Storage.set('ft_current',cur); };
        r.readAsDataURL(file);
      };

      saveBtn.onclick = ()=>{
        const cur=Storage.get('ft_current',{})||{};
        const fn=document.getElementById('fullName').value.trim();
        if(!fn) return alert('Full name required');
        cur.name=fn; fields.slice(1).forEach(f=>cur[f]=document.getElementById(f).value);
        Storage.set('ft_current',cur); alert('Saved!');
      };
      logoutBtn.onclick = ()=>{
        Storage.set('ft_current',{}); location.replace('home.html');
      };

      Storage.onChange('ft_current',()=>{
        populate(); updateAvatars();
      });

      populate(); updateAvatars();
    });
  </script>
</body>
</html>
