<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FitTrack | Profile</title>

  <!-- Google Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <script defer src="https://kit.fontawesome.com/a2e8f1b6b1.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
  :root {
    --bg: #0d0d0d;
    --fg: #fff;
    --accent: rgba(255,255,255,0.05);
    --input-bg: rgba(255,255,255,0.1);
    --gold: #ff9800;
    --font-base: 'Raleway', sans-serif;
    --font-head: 'Poppins', sans-serif;
    --transition: .3s ease;
    --sidebar-w: 80px;
  }
  *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
  body {
    display:flex; min-height:100vh;
    background:var(--bg); color:var(--fg);
    font-family:var(--font-base);
  }
  a { color:inherit; text-decoration:none; }
  #overlay {
    position:fixed; inset:0; background:rgba(0,0,0,0.5);
    opacity:0; visibility:hidden; transition:opacity var(--transition);
    z-index:90;
  }
  #overlay.active { opacity:1; visibility:visible; }

  /* Sidebar */
  .sidebar {
    width:var(--sidebar-w); background:rgba(0,0,0,0.9);
    border-right:2px solid var(--gold);
    display:flex; flex-direction:column; align-items:center;
    padding-top:1rem; position:sticky; top:0; height:100vh;
    z-index:100;
  }
  .sidebar .logo { font-size:1.6rem; color:var(--gold); margin-bottom:1.5rem; }
  .sidebar a.menu-item,
  .sidebar button.profile-menu {
    width:100%; padding:.8rem 0;
    display:flex; flex-direction:column; align-items:center; gap:.3rem;
    color:var(--fg); background:none; border:none;
    transition:background var(--transition);
  }
  .sidebar a.menu-item:hover,
  .sidebar a.menu-item.active,
  .sidebar button.profile-menu.active {
    background:var(--accent);
  }
  .sidebar a.menu-item i,
  .sidebar button.profile-menu i.avatar { font-size:1.4rem; }
  .sidebar a.menu-item span,
  .sidebar button.profile-menu span   { font-size:.75rem; }
  .sidebar .sign-out { margin-top:auto; margin-bottom:1rem!important; }
  img.avatar-small, i.avatar-small {
    width:28px; height:28px; border-radius:50%; object-fit:cover;
  }

  /* Main & Header */
  .main { flex:1; display:flex; flex-direction:column; }
  header {
    position:sticky; top:0; background:rgba(0,0,0,0.9);
    border-bottom:2px solid var(--gold);
    padding:1rem 1.5rem; display:flex; align-items:center; justify-content:space-between;
    z-index:200;
  }
  header h1 { color:var(--gold); font-family:var(--font-head); font-size:1.6rem; }
  .header-controls { display:flex; align-items:center; gap:1rem; }
  .header-controls button {
    background:none; border:none; color:var(--fg); cursor:pointer; font-size:1.2rem;
  }
  .avatar-btn {
    width:36px; height:36px; border:2px solid var(--gold); border-radius:50%;
    overflow:hidden; display:flex; align-items:center; justify-content:center;
  }
  .avatar-btn img { width:100%; height:100%; object-fit:cover; }

  /* Profile Form */
  .container { flex:1; overflow-y:auto; }
  .content { padding:2rem; }
  #profileForm {
    max-width:900px; margin:0 auto; background:var(--accent);
    border-radius:12px; padding:2rem;
    display:grid; grid-template-columns:1fr 2fr; gap:2rem;
  }
  .avatar-section {
    display:flex; flex-direction:column; align-items:center; gap:1rem;
  }
  #avatarPreview {
    width:160px; height:160px; border-radius:50%;
    background:var(--input-bg); display:flex; align-items:center; justify-content:center;
    font-size:4rem; color:rgba(255,255,255,0.5); overflow:hidden;
  }
  .avatar-buttons { display:flex; gap:.5rem; }
  .avatar-buttons button {
    background:var(--gold); color:var(--bg); padding:.4rem .8rem;
    border:none; border-radius:6px; cursor:pointer;
  }
  .fields { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; }
  .field { display:flex; flex-direction:column; }
  .field label {
    margin-bottom:.3rem; font-weight:600; font-family:var(--font-head);
  }
  .field input, .field select, .field textarea {
    padding:.6rem; border-radius:6px; border:1px solid rgba(255,255,255,0.3);
    background:var(--input-bg); color:var(--fg); font-size:1rem;
  }
  .field textarea { resize:vertical; min-height:80px; grid-column:span 2; }
  .completion-container {
    grid-column:1/-1; margin-top:1rem;
  }
  .completion-bar {
    background:rgba(255,255,255,0.2); border-radius:6px; overflow:hidden; height:12px;
  }
  #completionFill {
    height:100%; width:0; background:var(--gold); transition:width .5s ease;
  }
  .actions {
    grid-column:span 2; display:flex; justify-content:flex-end; margin-top:1.5rem;
  }
  .actions button {
    background:var(--gold); color:var(--bg); border:none;
    padding:.75rem 1.5rem; border-radius:30px; cursor:pointer;
    font-weight:600;
  }

  /* Profile Summary */
  #profileSummary {
    max-width:900px; margin:2rem auto; background:var(--accent);
    border-radius:12px; padding:1.5rem;
  }
  #profileSummary h2 { color:var(--gold); margin-bottom:.5rem; }
  #profileSummary ul { list-style:none; }
  #profileSummary li { margin-bottom:.4rem; }

  @media(max-width:900px) {
    #profileForm { grid-template-columns:1fr; }
    .fields { grid-template-columns:1fr; }
    .field textarea { grid-column:span 1; }
  }
  </style>
</head>
<body>
  <div id="overlay"></div>

  <aside class="sidebar" id="sidebar">
    <div class="logo"><i class="fas fa-heartbeat"></i></div>
    <a href="dashboard.html"   class="menu-item"><i class="fas fa-tachometer-alt"></i><span>Dash</span></a>
    <a href="log.html"         class="menu-item"><i class="fas fa-pen"></i><span>Log</span></a>
    <a href="workouts.html"    class="menu-item"><i class="fas fa-dumbbell"></i><span>Workouts</span></a>
    <a href="leaderboard.html" class="menu-item"><i class="fas fa-trophy"></i><span>Board</span></a>
    <button id="profileSidebarBtn" class="menu-item profile-menu active">
      <i id="sideAvatar" class="fas fa-user-circle avatar-small"></i>
      <span>Profile</span>
    </button>
    <a href="home.html"        class="menu-item sign-out"><i class="fas fa-sign-out-alt"></i><span>Sign Out</span></a>
  </aside>

  <div class="main">
    <header>
      <h1>My Profile</h1>
      <div class="header-controls">
        <button id="logoutBtn" title="Sign Out"><i class="fas fa-sign-out-alt"></i></button>
        <button class="avatar-btn" id="hdrAvatarBtn">
          <i id="hdrAvatarIcon" class="fas fa-user-circle avatar-small"></i>
        </button>
      </div>
    </header>

    <div class="container">
      <div class="content">
        <form id="profileForm">
          <div class="avatar-section">
            <div id="avatarPreview"><i class="fas fa-user"></i></div>
            <div class="avatar-buttons">
              <button type="button" id="changeAvatarBtn">Change</button>
              <button type="button" id="removeAvatarBtn">Remove</button>
            </div>
            <input type="file" id="avatarInput" accept="image/*" style="display:none;">
          </div>

          <div class="fields">
            <div class="field"><label for="fullName">Full Name *</label><input id="fullName" type="text" required></div>
            <div class="field"><label for="email">Email</label><input id="email" type="email" disabled></div>
            <div class="field"><label for="bio">Bio</label><textarea id="bio"></textarea></div>
            <div class="field"><label for="location">Location</label><input id="location" type="text"></div>
            <div class="field"><label for="age">Age</label><input id="age" type="number" min="0"></div>
            <div class="field"><label for="gender">Gender</label>
              <select id="gender">
                <option value="">Prefer not to say</option><option>Female</option><option>Male</option><option>Other</option>
              </select>
            </div>
            <div class="field"><label for="height">Height (cm)</label><input id="height" type="number" min="0"></div>
            <div class="field"><label for="weight">Weight (kg)</label><input id="weight" type="number" min="0"></div>
            <div class="field"><label for="favorite">Favorite Workout</label>
              <select id="favorite">
                <option>Running</option><option>Cycling</option><option>Swimming</option><option>HIIT</option><option>Yoga</option>
              </select>
            </div>
            <div class="field"><label for="goals">Fitness Goals</label><textarea id="goals"></textarea></div>

            <div class="completion-container">
              <label>Profile Completion:</label>
              <div class="completion-bar"><div id="completionFill"></div></div>
            </div>
          </div>

          <div class="actions">
            <button type="button" id="saveBtn">Save Changes</button>
          </div>
        </form>

        <div id="profileSummary">
          <h2>Your Profile Summary</h2>
          <ul>
            <li><strong>Name:</strong> <span id="sumName">—</span></li>
            <li><strong>Email:</strong> <span id="sumEmail">—</span></li>
            <li><strong>Bio:</strong> <span id="sumBio">—</span></li>
            <li><strong>Location:</strong> <span id="sumLocation">—</span></li>
            <li><strong>Age/Gender:</strong> <span id="sumAgeGender">—</span></li>
            <li><strong>Height/Weight:</strong> <span id="sumHW">—</span></li>
            <li><strong>Favorite:</strong> <span id="sumFavorite">—</span></li>
            <li><strong>Goals:</strong> <span id="sumGoals">—</span></li>
            <li><strong>Total Workouts:</strong> <span id="sumWorkouts">0</span></li>
            <li><strong>Total Distance:</strong> <span id="sumDistance">0 km</span></li>
            <li><strong>Total Calories:</strong> <span id="sumCalories">0</span></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- storage.js helper -->
  <script type="module" src="storage.js"></script>
  <script type="module">
    import { Storage } from './storage.js';

    // Elements
    const form           = document.getElementById('profileForm');
    const fields         = ['fullName','bio','location','age','gender','height','weight','favorite','goals'];
    const avatarInput    = document.getElementById('avatarInput');
    const avatarPreview  = document.getElementById('avatarPreview');
    const completionFill = document.getElementById('completionFill');
    const sum            = {
      name:    document.getElementById('sumName'),
      email:   document.getElementById('sumEmail'),
      bio:     document.getElementById('sumBio'),
      location:document.getElementById('sumLocation'),
      ageGender:document.getElementById('sumAgeGender'),
      hw:      document.getElementById('sumHW'),
      favorite:document.getElementById('sumFavorite'),
      goals:   document.getElementById('sumGoals'),
      workouts:document.getElementById('sumWorkouts'),
      distance:document.getElementById('sumDistance'),
      calories:document.getElementById('sumCalories')
    };

    // Update sidebar & header avatars
    function updateAvatars(url) {
      const imgHTML = `<img src="${url}" class="avatar-small" />`;
      document.getElementById('sideAvatar').outerHTML = imgHTML;
      document.getElementById('hdrAvatarIcon').outerHTML = imgHTML;
    }

    // Populate form & preview
    function populate() {
      const cur = Storage.get('ft_current', {});
      document.getElementById('fullName').value = cur.name || '';
      document.getElementById('email').value    = cur.email || '';
      document.getElementById('bio').value      = cur.bio || '';
      document.getElementById('location').value = cur.location || '';
      document.getElementById('age').value      = cur.age || '';
      document.getElementById('gender').value   = cur.gender || '';
      document.getElementById('height').value   = cur.height || '';
      document.getElementById('weight').value   = cur.weight || '';
      document.getElementById('favorite').value = cur.favorite || 'Running';
      document.getElementById('goals').value     = cur.goals || '';
      if (cur.avatarDataUrl) {
        avatarPreview.style.backgroundImage = `url(${cur.avatarDataUrl})`;
        avatarPreview.innerHTML = '';
      } else {
        avatarPreview.style.backgroundImage = '';
        avatarPreview.innerHTML = '<i class="fas fa-user"></i>';
      }
      updateCompletion();
      updateSummary();
    }

    // Compute & update completion bar
    function updateCompletion() {
      const cur = Storage.get('ft_current', {});
      let count = 0;
      if (cur.name) count++;
      if (cur.bio) count++;
      if (cur.location) count++;
      if (cur.age) count++;
      if (cur.gender) count++;
      if (cur.height) count++;
      if (cur.weight) count++;
      if (cur.favorite) count++;
      if (cur.goals) count++;
      if (cur.avatarDataUrl) count++;
      const pct = Math.round(count / 10 * 100);
      completionFill.style.width = pct + '%';
    }

    // Populate profile summary & stats
    function updateSummary() {
      const cur = Storage.get('ft_current', {});
      sum.name.textContent = cur.name || '—';
      sum.email.textContent= cur.email || '—';
      sum.bio.textContent = cur.bio || '—';
      sum.location.textContent = cur.location || '—';
      sum.ageGender.textContent = ((cur.age||'')+' / '+(cur.gender||'—')).replace(/\/\s*—$/,'');
      sum.hw.textContent = ((cur.height||'')+' cm / '+(cur.weight||'')+' kg').replace(/\/\s*kg$/,'');
      sum.favorite.textContent = cur.favorite || '—';
      sum.goals.textContent = cur.goals || '—';

      // stats from activities
      const acts = Storage.get('ft_activities', []);
      const totalWorkouts = acts.length;
      const totalDistance = acts.reduce((s,a)=>s+(+a.distance||0),0).toFixed(1);
      const totalCalories = acts.reduce((s,a)=>s+(+a.calories||0),0);
      sum.workouts.textContent = totalWorkouts;
      sum.distance.textContent = totalDistance + ' km';
      sum.calories.textContent = totalCalories;
    }

    // Bind avatar change/remove
    document.getElementById('changeAvatarBtn').onclick = ()=> avatarInput.click();
    document.getElementById('removeAvatarBtn').onclick = () => {
      const cur = Storage.get('ft_current', {});
      delete cur.avatarDataUrl;
      Storage.set('ft_current', cur);
      Storage.set('ft_profile', {...cur, avatarDataUrl: undefined, profileComplete:cur.profileComplete});
    };
    avatarInput.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const cur = Storage.get('ft_current', {});
        cur.avatarDataUrl = reader.result;
        Storage.set('ft_current', cur);
        Storage.set('ft_profile', {...cur, avatarDataUrl:cur.avatarDataUrl, profileComplete:cur.profileComplete});
      };
      reader.readAsDataURL(file);
    };

    // Bind save button
    document.getElementById('saveBtn').onclick = () => {
      const cur = Storage.get('ft_current', {});
      cur.name      = document.getElementById('fullName').value.trim();
      if (!cur.name) return alert('Full Name is required');
      cur.bio       = document.getElementById('bio').value;
      cur.location  = document.getElementById('location').value;
      cur.age       = document.getElementById('age').value;
      cur.gender    = document.getElementById('gender').value;
      cur.height    = document.getElementById('height').value;
      cur.weight    = document.getElementById('weight').value;
      cur.favorite  = document.getElementById('favorite').value;
      cur.goals     = document.getElementById('goals').value;
      cur.profileComplete = true;
      Storage.set('ft_current', cur);
      Storage.set('ft_profile', {
        name: cur.name,
        avatarDataUrl: cur.avatarDataUrl,
        profileComplete: true
      });
      alert('Profile saved!');
    };

    // Update on storage changes
    Storage.onChange('ft_current', () => {
      populate();
      updateAvatars(Storage.get('ft_current').avatarDataUrl || '');
    });

    // Initial populate
    document.addEventListener('DOMContentLoaded', () => {
      populate();
      updateAvatars(Storage.get('ft_current').avatarDataUrl || '');
    });

    // Logout button
    document.getElementById('logoutBtn').onclick = () => {
      // Clear current user & redirect
      Storage.set('ft_current', {});
      location.replace('home.html');
    };
  </script>
</body>
</html>
