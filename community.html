<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FitTrack | Community</title>

  <!-- Google Fonts & FontAwesome -->

  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>


  <style>
    /* ‚Üê exactly your leaderboard.html styles‚Ä¶ */
    :root {
      --bg: #000;
      --gold: #ff9800;
      --white: #fff;
      --accent: rgba(255,255,255,0.05);
      --font-base: 'Raleway', sans-serif;
      --font-head: 'Poppins', sans-serif;
      --sidebar-w: 80px;
      --mobile-w: 200px;
      --transition: .3s;
    }
    *,*::before,*::after { margin:0; padding:0; box-sizing:border-box; }
    body {
      display:flex; min-height:100vh;
      background:var(--bg); color:var(--white);
      font-family:var(--font-base); overflow-x:hidden;
    }
    a { color:inherit; text-decoration:none; }
    button { font-family:var(--font-head); cursor:pointer; border:none; background:none; transition:var(--transition); }

    /* Overlay */
    #overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:90; }
    #overlay.active { display:block; }

    /* Notification Banner */
    #completeProfileBanner {
      display:none; position:fixed; top:1rem; left:50%; transform:translateX(-50%);
      background:rgba(255,152,0,0.1); border-left:4px solid var(--gold);
      padding:.8rem 1.5rem; color:var(--white); z-index:2000;
    }

    /* SIDEBAR */
    .sidebar {
      width:var(--sidebar-w);
      background:rgba(0,0,0,0.9);
      border-right:2px solid var(--gold);
      display:flex; flex-direction:column; align-items:center;
      padding:1rem 0; position:sticky; top:0; height:100vh;
      z-index:1000;
    }
    @media(max-width:600px){
      .sidebar { position: fixed; left: -100%; width: var(--mobile-w); }
      .sidebar.open { left: 0; }
    }
    .sidebar .logo { font-size:1.8rem; color:var(--gold); margin-bottom:2rem; }
    .sidebar a.menu-item, .sidebar button.profile-menu {
      width:100%; padding:.8rem 0;
      display:flex; flex-direction:column; align-items:center; gap:.3rem;
      background:transparent; color:var(--white);
      transition:background var(--transition);
    }
    .sidebar a.menu-item.active,
    .sidebar a.menu-item:hover,
    .sidebar button.profile-menu:hover {
      background:rgba(255,152,0,0.2);
    }
    .sidebar a.menu-item i,
    .sidebar button.profile-menu i.avatar { font-size:1.4rem; }
    .sidebar a.menu-item span,
    .sidebar button.profile-menu span   { font-size:.75rem; }
    .sidebar a.sign-out { margin-top:auto; margin-bottom:1rem!important; }
    img.avatar, i.avatar {
      width:32px; height:32px; border-radius:50%;
      object-fit:cover; border:2px solid var(--white);
    }

    /* Main & Header */
    .main { flex:1; display:flex; flex-direction:column; }
    @media(max-width:600px){ .main { margin-left:0; } }
    header {
      display:flex; align-items:center; justify-content:space-between;
      padding:1rem 1.5rem; background:rgba(0,0,0,0.9);
      border-bottom:2px solid var(--gold);
      position:sticky; top:0; width:100%; z-index:200;
    }
    .hamburger { display:none; font-size:1.4rem; }
    .logo-header { font-family:var(--font-head); font-size:1.4rem; color:var(--gold); }
    .search input {
      padding:.4rem .6rem; background:var(--accent);
      border:1px solid var(--accent); border-radius:6px; color:var(--white);
    }
    .controls { display:flex; align-items:center; gap:.5rem; }
    .controls select, .controls button {
      padding:.4rem .6rem; background:var(--accent);
      border:1px solid var(--accent); border-radius:6px; color:var(--white);
    }
    .avatar-btn img { width:32px; height:32px; border-radius:50%; object-fit:cover; }
    @media(max-width:600px){
      .hamburger { display:block; }
      .search, .controls select { display:none; }
    }

    /* CONTENT WRAPPER */
    .container { flex:1; overflow-y:auto; padding:1rem; }

    /*‚Äî COMMUNITY FEED SPECIFIC ‚Äî*/
    .post-box {
      background: var(--accent);
      padding: 1rem;
      border-radius: 8px;
      display: flex;
      gap: .75rem;
      margin-bottom: 1.5rem;
    }
    .post-box input {
      flex: 1;
      padding: .6rem;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.05);
      color: var(--white);
    }
    .post-box button {
      background: var(--gold);
      border: none;
      color: var(--bg);
      padding: .6rem 1.2rem;
      border-radius: 20px;
      cursor: pointer;
    }

    .feed-list { list-style:none; padding:0; }
    .feed-item {
      background: var(--accent);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
    }
    .feed-header {
      display: flex; align-items:center; gap:.75rem;
    }
    .feed-avatar {
      width: 36px; height:36px;
      border-radius:50%;
      object-fit:cover;
      background:#555;
    }
    .feed-meta .user { color:var(--gold); font-weight:600; }
    .feed-meta .time { font-size:.8rem; color:var(--white); opacity:.6; }
    .feed-text { margin: .75rem 0; line-height:1.4; }
    .feed-controls {
      display: flex; gap:1.2rem;
      border-top:1px solid rgba(255,255,255,0.1);
      padding-top:.75rem;
    }
    .feed-controls button {
      background:none; border:none; color:var(--white);
      cursor:pointer; display:flex; align-items:center; gap:.4rem;
      transition:color .2s;
    }
    .feed-controls button:hover { color:var(--gold); }
    .comments-container {
      max-height:0; overflow:hidden;
      transition:max-height .3s ease;
      margin-top:.75rem; border-top:1px solid rgba(255,255,255,0.1);
      padding-top:.75rem;
    }
    .comments-container.open { max-height:600px; }
    .comment-item {
      display:flex; align-items:flex-start; gap:.6rem; margin-bottom:.6rem;
    }
    .comment-avatar {
      width:28px; height:28px; border-radius:50%; object-fit:cover; background:#777;
    }
    .comment-content {
      background: rgba(255,255,255,0.05);
      padding:.5rem .75rem;
      border-radius:6px;
      flex:1;
    }
    .comment-content .author { color:var(--gold); font-weight:600; margin-bottom:.2rem; }
    .comment-content .text  { line-height:1.3; }

    /* Chatbot */
    .chatbot { display: none !important; }
    .chatbot.active { display: flex !important; }
  </style>

</head>

<body>
  <!-- Profile‚Äêcompletion banner -->
  <div id="completeProfileBanner">
    üëã Don‚Äôt forget to <a href="profile.html">complete your profile</a>!
  </div>

  <!-- Sidebar -->

  <div id="overlay" onclick="toggleSidebar()"></div>
  <aside class="sidebar" id="sidebar">
    <div class="logo"><i class="fas fa-heartbeat"></i></div>
    <a href="dashboard.html" class="menu-item"><i class="fas fa-tachometer-alt"></i><span>Dash</span></a>
    <a href="log.html"       class="menu-item"><i class="fas fa-pen"></i><span>Log</span></a>
    <a href="workouts.html"  class="menu-item"><i class="fas fa-dumbbell"></i><span>Workouts</span></a>
    <a href="leaderboard.html" class="menu-item"><i class="fas fa-trophy"></i><span>Board</span></a>
    <a href="community.html" class="menu-item active"><i class="fas fa-users"></i><span>Community</span></a>
    <button class="menu-item profile-menu" id="profileBtn">
      <i class="fas fa-user-circle avatar" id="side-avatar"></i><span>Profile</span>
    </button>
    <a href="signout.html" class="menu-item sign-out"><i class="fas fa-sign-out-alt"></i><span>Sign Out</span></a>
  </aside>


  <!-- Main content -->
  <div class="main">
    <header>
      <button class="hamburger" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <div class="logo-header"><i class="fas fa-users"></i> Community</div>
      <div class="controls">
        <button id="notifBtn"><i class="fas fa-bell"></i></button>
        <button class="avatar-btn" id="hdrAvatarBtn">
          <i class="fas fa-user-circle avatar" id="hdrAvatarIcon"></i>
        </button>
      </div>
    </header>

    <div class="container">
      <!-- New post -->
      <div class="post-box">
        <input id="newFeedInput" placeholder="Share something‚Ä¶"/>
        <button id="postFeedBtn"><i class="fas fa-paper-plane"></i> Post</button>
      </div>

      <!-- Feed list -->
      <ul class="feed-list" id="communityFeed"></ul>
    </div>
  </div> 
  <!-- Chatbot for Community -->
  <div id="lb-chatbot" class="chatbot">
    <header><i class="fas fa-comments"></i> Community Bot
      <button id="lb-chat-close">&times;</button>
    </header>
    <div class="messages" id="lb-chat-messages">
      <div class="msg bot">Hi! Ask me about the feed‚Ä¶</div>
    </div>
    <div class="input">
      <input list="lb-questions" id="lb-chat-input" placeholder="Your question‚Ä¶"/>
      <datalist id="lb-questions"></datalist>
      <button id="lb-ask-btn"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
  <button id="lb-chat-toggle" class="chat-toggle"><i class="fas fa-comments"></i></button>


  <script src="storage.js"></script>

  <!-- 2) Community page logic -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ‚îÄ‚îÄ Redirect if not logged in ‚îÄ‚îÄ
      const cur = Storage.get('ft_current', null);
      if (!cur || !cur.name) return location.replace('home.html');

      // ‚îÄ‚îÄ Avatar sync ‚îÄ‚îÄ
      function updateAvatars() {
        const p   = Storage.get('ft_current', {}) || {};
        const url = p.avatarDataUrl
          || `https://i.pravatar.cc/150?u=${encodeURIComponent(p.email||p.name)}`;
        ['side-avatar','hdrAvatarIcon'].forEach(id => {
          const old = document.getElementById(id);
          if (!old) return;
          const img = document.createElement('img');
          img.id        = id;
          img.className = 'avatar';
          img.src       = url;
          img.alt       = 'Avatar';
          old.replaceWith(img);
        });
      }
      updateAvatars();
      Storage.onChange('ft_current', updateAvatars);

      // ‚îÄ‚îÄ Sidebar toggle ‚îÄ‚îÄ
      window.toggleSidebar = () => {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('active');
      };

      // ‚îÄ‚îÄ Refs & state ‚îÄ‚îÄ
      const feedEl  = document.getElementById('communityFeed');
      const input   = document.getElementById('newFeedInput');
      const postBtn = document.getElementById('postFeedBtn');
      const me      = cur.name;

      // ‚îÄ‚îÄ Seed feed once ‚îÄ‚îÄ
      if (!Storage.get('ft_feed')) {
        const users  = ['Alice','Bob','Cara','Dan','Eve','Finn','Gina','Hank','Ivy','Jack','Kara','Liam','Mia','Noah','Olive'];
        const texts  = [
          "Just crushed 10k steps today!",  "Morning HIIT session was üî•",  "Yoga helped my flexibility so much!",
          "Hit a new PR on deadlift: 120kg!", "Tried a new smoothie recipe üçìü•§", "Weekend trail run was epic!",
          "Group class at 6am? Count me in!", "Leg day left me walking funny üòÇ", "Protein pancakes for breakfast!",
          "Hit my weekly goal: 5 workouts!", "Cooldown stretches are underrated.", "First 50 pushups in a row!",
          "Beat my plank time: 2 minutes!", "Joined the 30-day squat challenge!", "Early bird workout = best mood!"
        ];
        const replies = ["Awesome!","Keep going!","You rock!","So inspiring!","Well done!","üî•üî•","Nice work!","Goals!","Legend!","üí™","Woo!","Amazing!"];

        const feed = texts.map((t,i)=>({
          user: users[i],
          avatar:`https://i.pravatar.cc/40?u=${users[i]}`,
          text: t,
          timestamp: Date.now() - Math.random()*3600000,
          likes: Math.floor(Math.random()*20)+15
        }));

        const comments = feed.map(() => {
          const n = 5 + Math.floor(Math.random()*4);
          return Array.from({length:n}).map(() => {
            const u = users[Math.floor(Math.random()*users.length)];
            return { user: u, avatar:`https://i.pravatar.cc/40?u=${u+Math.random()}`, text: replies[Math.floor(Math.random()*replies.length)] };
          });
        });

        Storage.set('ft_feed', feed);
        Storage.set('ft_comments', comments);
      }

      // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
      function render() {
        const feed  = Storage.get('ft_feed');
        const cmnts = Storage.get('ft_comments');
        feedEl.innerHTML = '';
        feed.forEach((post, idx) => {
          const ago = Math.floor((Date.now() - post.timestamp)/60000);
          const li = document.createElement('li');
          li.className     = 'feed-item';
          li.dataset.index = idx;
          li.innerHTML = `
            <div class="feed-header">
              <img class="feed-avatar" src="${post.avatar}" />
              <div class="feed-meta">
                <span class="user">${post.user}</span>
                <span class="time">${ago}m ago</span>
              </div>
            </div>
            <div class="feed-text">${post.text}</div>
            <div class="feed-controls">
              <button class="like-btn"><i class="fas fa-heart"></i>
                <span class="like-count">${post.likes}</span>
              </button>
              <button class="toggle-comments">‚ñº ${cmnts[idx].length} comments</button>
            </div>
            <div class="comments-container">
              ${cmnts[idx].map(c=>`
                <div class="comment-item">
                  <img class="comment-avatar" src="${c.avatar}"/>
                  <div class="comment-content">
                    <div class="author">${c.user}</div>
                    <div class="text">${c.text}</div>
                  </div>
                </div>
              `).join('')}
            </div>`;
          feedEl.appendChild(li);
        });
      }

      // ‚îÄ‚îÄ Post event ‚îÄ‚îÄ
      postBtn.addEventListener('click', ()=>{
        const text = input.value.trim();
        if (!text) return input.focus();
        const feed = Storage.get('ft_feed');
        feed.unshift({ user: me, avatar:`https://i.pravatar.cc/40?u=${me}`, text, timestamp: Date.now(), likes:0 });
        Storage.set('ft_feed', feed);
        Storage.set('ft_comments', [[],...Storage.get('ft_comments')]);
        input.value = '';
        render();
      });

      // ‚îÄ‚îÄ Delegate clicks ‚îÄ‚îÄ
      feedEl.addEventListener('click', e => {
        const item = e.target.closest('.feed-item');
        if (!item) return;
        const idx = +item.dataset.index;

        // Like
        if (e.target.closest('.like-btn')) {
          const feed = Storage.get('ft_feed');
          feed[idx].likes++;
          Storage.set('ft_feed', feed);
          item.querySelector('.like-count').textContent = feed[idx].likes;
          return;
        }

        // Toggle comments
        if (e.target.closest('.toggle-comments')) {
          const cont = item.querySelector('.comments-container');
          const btn  = item.querySelector('.toggle-comments');
          cont.classList.toggle('open');
          const open = cont.classList.contains('open');
          btn.textContent = `${open?'‚ñ≤':'‚ñº'} ${Storage.get('ft_comments')[idx].length} comments`;
          return;
        }

        // Add comment by tapping text
        if (e.target.closest('.feed-text')) {
          const reply = prompt('Add a comment:');
          if (!reply) return;
          const allC = Storage.get('ft_comments');
          allC[idx].push({ user: me, avatar:`https://i.pravatar.cc/40?u=${me+Math.random()}`, text:reply });
          Storage.set('ft_comments', allC);
          render();
        }
      });

      // ‚îÄ‚îÄ Chatbot toggle ‚îÄ‚îÄ
      const cb = document.getElementById('lb-chatbot');
      const ct = document.getElementById('lb-chat-toggle');
      const cc = document.getElementById('lb-chat-close');
      ct.addEventListener('click', ()=>{ cb.classList.add('active'); ct.style.display='none'; });
      cc.addEventListener('click', ()=>{ cb.classList.remove('active'); ct.style.display='flex'; });

      // ‚îÄ‚îÄ Live update ‚îÄ‚îÄ
      Storage.onChange(['ft_feed','ft_comments'], render);

      // ‚îÄ‚îÄ Kick it off ‚îÄ‚îÄ
      render();
    });
  </script>
</body>
</html>
