<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FitTrack | Dashboard</title>

  <!-- FONTS & ICONS -->
  <link
    href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"/>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
  />

  <!-- CHART.JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- YOUR STORAGE ABI -->
  <script src="storage.js"></script>

  <style>
    :root {
      --bg: #000;
      --gold: #ff9800;
      --white: #fff;
      --font-base: 'Raleway', sans-serif;
      --font-head: 'Poppins', sans-serif;
      --transition: .3s ease;
      --sidebar-w: 80px;
      --header-h: 60px;
      --notif-h: 48px;
      --header-z: 200;
      --sidebar-z: 100;
      --overlay-z: 90;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      display:flex;
      min-height:100vh;
      background:var(--bg);
      color:var(--white);
      font-family:var(--font-base);
      overflow-x:hidden;
    }
    a { color:inherit; text-decoration:none; }
    button, input, select, textarea {
      font-family:var(--font-head);
      transition:var(--transition);
    }
    button { cursor:pointer; background:transparent; border:none; color:var(--white); }

    /* Sidebar */
    .sidebar {
      width:var(--sidebar-w);
      background:rgba(0,0,0,0.9);
      border-right:2px solid var(--gold);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding-top:1rem;
      position:sticky;
      top:0;
      height:100vh;
      z-index:var(--sidebar-z);
    }
    .sidebar a, .sidebar button {
      width:100%; padding:.8rem 0;
      display:flex; flex-direction:column; align-items:center; gap:.3rem;
      color:var(--white);
    }
    .sidebar a.active,
    .sidebar a:hover,
    .sidebar button:hover {
      background:rgba(255,152,0,0.2);
    }
    .sidebar .logo { font-size:1.6rem; color:var(--gold); margin-bottom:2rem; }
    .sidebar .sign-out { margin-top:auto; margin-bottom:1rem; }
    .avatar { width:32px; height:32px; border-radius:50%; border:2px solid var(--white); object-fit:cover; }

    /* Main layout */
    .main { flex:1; display:flex; flex-direction:column; }

    header {
      display:flex; align-items:center; justify-content:space-between;
      height:var(--header-h); padding:0 1.5rem;
      background:rgba(0,0,0,0.9); border-bottom:2px solid var(--gold);
      position:sticky; top:0; z-index:var(--header-z);
    }
    header h1 { font-size:1.4rem; color:var(--white); flex:1; text-align:center; }
    .new-workout {
      display:flex; align-items:center; gap:.4rem;
      background:var(--gold); color:var(--bg);
      border-radius:30px; padding:.5rem 1rem;
    }

    /* Notification bar */
    .notif-bar {
      position:fixed;
      top:var(--header-h);
      left:var(--sidebar-w);
      right:0;
      height:var(--notif-h);
      display:flex; align-items:center; justify-content:space-between;
      background:rgba(255,152,0,0.15);
      border-left:4px solid var(--gold);
      padding:0 .8rem;
      font-size:.95rem;
      z-index:calc(var(--header-z) + 1);
    }
    .notif-bar.hidden { display:none; }
    .notif-bar button { font-size:1.2rem; }

    /* Overlay */
    .overlay {
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,0.5); z-index:var(--overlay-z);
    }
    .overlay.active { display:block; }

    /* Page Content */
    .content {
      padding:1rem 1.5rem;
      margin-top: calc(var(--notif-h) + var(--header-h));
      overflow-y:auto;
      flex:1;
    }
    .stats, .goals, .charts, .actions-grid,
    .quick-log, .daily-tip, .daily-challenge,
    .live-sessions, .mini-board, .community,
    .top-achievements {
      margin-top:1.5rem;
    }

    /* Stat Cards */
    .stats { display:grid; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); }
    .stat-card {
      background:rgba(255,255,255,0.05);
      border-radius:8px; padding:1rem; text-align:center;
      transition:var(--transition);
    }
    .stat-card:hover { background:rgba(255,255,255,0.1); }
    .stat-card i { font-size:1.4rem; color:var(--gold); margin-bottom:.4rem; }
    .stat-card h3 { font-size:1.2rem; }

    /* Goals & Progress */
    .progress h3 { margin-bottom:.5rem; }
    .bar-container {
      background:rgba(255,255,255,0.2);
      border-radius:6px; overflow:hidden; height:10px;
    }
    .bar-fill {
      width:0; height:100%; background:var(--gold);
      transition:width 1s ease;
    }
    .goals { display:grid; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); }
    .goal-card { background:rgba(255,255,255,0.05); border-radius:8px; padding:.8rem; }
    .goal-container {
      background:rgba(255,255,255,0.2);
      border-radius:6px; overflow:hidden; height:10px;
    }
    .goal-fill {
      width:0; height:100%; background:var(--gold);
      transition:width 1s ease;
    }

    /* Charts */
    .charts { display:grid; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); }
    .chart-card {
      background:rgba(255,255,255,0.05);
      border-radius:8px; padding:1rem;
    }
    .chart-card canvas { width:100% !important; height:300px !important; }

    /* Quick Log */
    .quick-log { background:rgba(255,255,255,0.05); border-radius:8px; padding:1rem; }
    .quick-log table {
      width:100%; border-collapse:collapse; margin-bottom:.8rem;
    }
    .quick-log th, .quick-log td {
      text-align:left; padding:.4rem; font-size:.9rem;
      border-bottom:1px solid rgba(255,255,255,0.2);
    }
    .fast-stats { display:flex; gap:1rem; font-size:.9rem; }

    /* Tip, Challenge, Community */
    .daily-tip, .daily-challenge, .community { background:rgba(255,255,255,0.05); border-radius:8px; padding:1rem; }
    .daily-tip h2, .daily-challenge h2, .community h2 {
      display:flex; align-items:center; gap:.5rem;
      color:var(--gold); font-size:1rem; margin-bottom:.75rem;
    }
    .daily-tip p, .daily-challenge p, .community ul {
      font-size:.9rem; line-height:1.4; opacity:.8;
    }
    .community ul { list-style:none; padding:0; }
    .community li { margin-bottom:.6rem; background:rgba(255,255,255,0.1); padding:.6rem; border-radius:6px; }

    /* Live Sessions */
    .live-sessions .live-grid {
      display:grid; gap:.75rem; grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    }
    .live-card {
      background:rgba(255,255,255,0.05);
      border-radius:8px; padding:.75rem; text-align:center;
      transition:var(--transition);
    }
    .live-card:hover { transform:translateY(-4px); box-shadow:0 4px 12px rgba(0,0,0,0.4);}
    .live-card img { width:100%; height:80px; object-fit:cover; border-radius:6px; margin-bottom:.5rem;}
    .live-card h3 { font-size:.95rem; margin-bottom:.25rem;}
    .live-card p { font-size:.8rem; opacity:.7;}
    .schedule-btn, .join-btn {
      margin-top:.5rem; padding:.4rem .8rem; border-radius:4px;
      background:var(--gold); color:var(--bg); font-size:.85rem;
    }

    /* Mini Leaderboard */
    .mini-board ol { margin-left:1.2rem; }

    /* Achievements */
    .top-achievements .achievements-grid {
      display:grid; gap:.75rem; grid-template-columns:repeat(auto-fit,minmax(80px,1fr));
    }
    .achievement-badge {
      background:rgba(255,255,255,0.05); border-radius:8px; padding:.75rem;
      text-align:center; opacity:.4; transition:.3s;
    }
    .achievement-badge.unlocked {
      opacity:1; box-shadow:0 4px 12px rgba(255,152,0,0.4);
    }
    .achievement-badge i { font-size:1.4rem; color:var(--gold); margin-bottom:.25rem;}
    .achievement-badge p { font-size:.8rem; margin:0; }

    /* Modal */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:2000;}
    .modal-overlay.active { display:flex; }
    .modal {
      background:var(--bg); border:2px solid var(--gold);
      border-radius:8px; padding:1.5rem; width:90%; max-width:360px; position:relative;
    }
    .modal .close { position:absolute; top:.6rem; right:.6rem; font-size:1.2rem; cursor:pointer; }
    .modal label { display:block; margin:.5rem 0 .2rem; font-size:.9rem; }
    .modal input, .modal select, .modal textarea {
      width:100%; padding:.6rem; margin-bottom:.8rem;
      border-radius:6px; border:1px solid rgba(255,255,255,0.3);
      background:rgba(255,255,255,0.05); color:var(--white);
    }
    .modal textarea { resize:vertical; }
    .modal button.primary {
      width:100%; background:var(--gold); color:var(--bg);
      padding:.6rem; border-radius:30px; font-size:1rem;
    }

    footer { text-align:center; padding:1rem 0; border-top:1px solid rgba(255,255,255,0.2); font-size:.9rem; opacity:.7;}
    @media (max-width:600px) {
      .sidebar { transform:translateX(-100%); position:fixed; width:75vw; max-width:260px; }
      .sidebar.open { transform:translateX(0); }
      header { padding:0 3rem; }
      .notif-bar { left:0; right:0; }
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="logo"><i class="fas fa-heartbeat"></i></div>
    <a href="dashboard.html" class="active"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
    <a href="log.html"><i class="fas fa-pen"></i><span>Log</span></a>
    <a href="workouts.html"><i class="fas fa-dumbbell"></i><span>Workouts</span></a>
    <a href="board.html"><i class="fas fa-trophy"></i><span>Board</span></a>
    <button class="profile-menu"><i class="fas fa-user-circle"></i><span>Profile</span></button>
    <a href="home.html" class="sign-out"><i class="fas fa-sign-out-alt"></i><span>Sign Out</span></a>
  </aside>

  <!-- Main -->
  <div class="main">
    <header>
      <h1 id="greeting">Loading…</h1>
      <button class="new-workout"><i class="fas fa-plus"></i> New Workout</button>
    </header>

    <!-- Notification -->
    <div id="notif-bar" class="notif-bar hidden">
      👋 Don’t forget to <a href="profile.html">complete your profile</a>.
      <button id="notif-close" aria-label="Close">&times;</button>
    </div>

    <div class="content">
      <!-- Profile summary -->
      <div class="profile-summary" style="display:flex; align-items:center; gap:1rem; margin-bottom:1.5rem;">
        <img id="dash-avatar" class="avatar" src="" alt="Your avatar">
        <h2 id="dash-name" style="font-size:1.2rem;"></h2>
      </div>

      <!-- Stats -->
      <section class="stats">
        <div class="stat-card"><i class="fas fa-dumbbell"></i><h3 id="workoutsCount">0</h3><p>This Month</p></div>
        <div class="stat-card"><i class="fas fa-road"></i><h3 id="distanceCount">0 km</h3><p>Distance</p></div>
        <div class="stat-card"><i class="fas fa-fire"></i><h3 id="caloriesCount">0</h3><p>Calories</p></div>
        <div class="stat-card"><i class="fas fa-calendar-day"></i><h3 id="activeDaysCount">0</h3><p>Active Days</p></div>
        <div class="stat-card"><i class="fas fa-stopwatch"></i><h3 id="todayTime">0 min</h3><p>Today’s Time</p></div>
        <div class="stat-card"><i class="fas fa-percentage"></i><h3 id="avgCalories">0</h3><p>Avg Calories</p></div>
      </section>

      <!-- Progress Bar -->
      <section class="progress">
        <h3><i class="fas fa-chart-line"></i> Weekly Goal</h3>
        <div class="bar-container"><div class="bar-fill" id="progressBar"></div></div>
      </section>

      <!-- Goals -->
      <section class="goals">
        <div class="goal-card"><p>Daily: 30 min</p><div class="goal-container"><div class="goal-fill" id="goalDaily"></div></div></div>
        <div class="goal-card"><p>Weekly: 5 workouts</p><div class="goal-container"><div class="goal-fill" id="goalWeekly"></div></div></div>
        <div class="goal-card"><p>Monthly: 20 workouts</p><div class="goal-container"><div class="goal-fill" id="goalMonthly"></div></div></div>
      </section>

      <!-- Charts -->
      <section class="charts">
        <div class="chart-card">
          <h3><i class="fas fa-chart-line"></i> Activity Over Time</h3>
          <canvas id="activityChart"></canvas>
        </div>
        <div class="chart-card">
          <h3><i class="fas fa-chart-pie"></i> Workout Distribution</h3>
          <canvas id="distributionChart"></canvas>
        </div>
      </section>

      <!-- Quick Log -->
      <section class="quick-log">
        <h2><i class="fas fa-history"></i> Recent Activities</h2>
        <table>
          <thead>
            <tr><th>Date</th><th>Type</th><th>Dur.</th><th>Km</th></tr>
          </thead>
          <tbody id="recent-acts"></tbody>
        </table>
        <div class="fast-stats">
          <div><strong id="avg-dur">0</strong> min avg</div>
          <div><strong id="tot-dist">0</strong> km total</div>
          <div><strong id="tot-cal">0</strong> cal total</div>
        </div>
      </section>

      <!-- Tip of the Day -->
      <section class="daily-tip">
        <h2><i class="fas fa-lightbulb"></i> Tip of the Day</h2>
        <p id="tip-of-day"></p>
      </section>

      <!-- Daily Challenge -->
      <section class="daily-challenge">
        <h2><i class="fas fa-bolt"></i> Daily Challenge</h2>
        <p id="dailyChallenge"></p>
      </section>

      <!-- Live Sessions -->
      <section class="live-sessions">
        <h2><i class="fas fa-video"></i> Upcoming Live Sessions</h2>
        <div class="live-grid" id="liveSessionsGrid"></div>
      </section>

      <!-- Mini Leaderboard -->
      <section class="mini-board">
        <h2><i class="fas fa-trophy"></i> Top 5</h2>
        <ol id="miniLeaderboard"></ol>
      </section>

      <!-- Community Feed -->
      <section class="community">
        <h2><i class="fas fa-comments"></i> Community Feed</h2>
        <ul id="communityFeed"></ul>
      </section>

      <!-- Achievements -->
      <section class="top-achievements">
        <h2><i class="fas fa-medal"></i> Your Achievements</h2>
        <div class="achievements-grid" id="yourAchievements"></div>
      </section>
    </div>

    <footer>
      <p>&copy; 2025 FitTrack. All rights reserved.</p>
    </footer>
  </div>

  <!-- Overlay for Sidebar -->
  <div id="overlay" class="overlay"></div>

  <!-- NEW WORKOUT MODAL -->
  <div id="workout-modal" class="modal-overlay">
    <div class="modal">
      <button id="workout-close" class="close" aria-label="Close">&times;</button>
      <h2>Log New Workout</h2>
      <label for="w-date">Date</label>
      <input type="date" id="w-date" />

      <label for="w-type">Type</label>
      <select id="w-type">
        <option value="Cardio">Cardio</option>
        <option value="Strength">Strength</option>
        <option value="Flexibility">Flexibility</option>
        <option value="Other">Other</option>
      </select>

      <label for="w-duration">Duration (mins)</label>
      <input type="number" id="w-duration" placeholder="e.g. 45" />

      <label for="w-distance">Distance (km)</label>
      <input type="number" id="w-distance" placeholder="e.g. 5.2" step="0.1" />

      <label for="w-calories">Calories Burned</label>
      <input type="number" id="w-calories" placeholder="e.g. 320" />

      <label for="w-notes">Notes</label>
      <textarea id="w-notes" rows="3" placeholder="How did it feel?"></textarea>

      <button id="w-save" class="primary">Save Workout</button>
    </div>
  </div>

  <!-- TOUR OVERLAY -->
  <div id="tour-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:3000;"></div>
  <div id="tour-tooltip" style="display:none;position:absolute;padding:1rem;background:#fff;color:#000;border-radius:5px;z-index:3001;"></div>

  <script type="module">
  import { Storage } from './storage.js';

  document.addEventListener('DOMContentLoaded', () => {
    // ─── 1) Redirect if not signed in ─────────────────────────
    const cur = Storage.get('ft_current', null);
    if (!cur || !cur.name) {
      return location.replace('home.html');
    }

    // ─── 2) Greeting & Profile Summary ───────────────────────
    const greetEl = document.getElementById('greeting');
    greetEl.textContent = cur.isNew
      ? `Welcome, ${cur.name}!`
      : `Welcome back, ${cur.name}!`;

    updateProfileSummary();

    // ─── 3) Notification & Tour on Sign‑Up ──────────────────
    const prof    = Storage.get('ft_profile', {});
    const notif   = document.getElementById('notif-bar');
    const closeNB = document.getElementById('notif-close');
    if (!prof.name || !prof.avatar) {
      notif.classList.remove('hidden');
    }
    closeNB.addEventListener('click', () => notif.classList.add('hidden'));

    if (cur.isNew) {
      // show tour
      runTour([
        { sel: '.stats', msg: 'Here are your month‑to‑date stats.' },
        { sel: '.daily-tip', msg: 'Get a fresh tip each day!' },
        { sel: '.live-sessions', msg: 'Join or schedule live workouts.' },
        { sel: '.mini-board', msg: 'See top performers on the leaderboard.' }
      ]);
      cur.isNew = false;
      Storage.set('ft_current', cur);
    }

    // ─── 4) Sidebar Toggle ────────────────────────────────
    const sidebar = document.getElementById('sidebar'),
          overlay = document.getElementById('overlay'),
          btnOpen = document.querySelector('.hamburger'),
          btnClose= document.getElementById('overlay');
    btnOpen?.addEventListener('click', () => {
      sidebar.classList.add('open'); overlay.classList.add('active');
    });
    btnClose.addEventListener('click', () => {
      sidebar.classList.remove('open'); overlay.classList.remove('active');
    });

    // ─── 5) Profile Nav ───────────────────────────────────
    document.querySelector('.profile-menu').onclick = () => location.href = 'profile.html';

    // ─── 6) Workout Modal ────────────────────────────────
    const modal  = document.getElementById('workout-modal'),
          openM  = document.querySelector('.new-workout'),
          closeM = document.getElementById('workout-close'),
          saveM  = document.getElementById('w-save');

    openM.addEventListener('click', ()=> modal.classList.add('active'));
    closeM.addEventListener('click', ()=> modal.classList.remove('active'));
    modal.addEventListener('click', e => {
      if (e.target === modal) modal.classList.remove('active');
    });

    saveM.addEventListener('click', () => {
      const date     = document.getElementById('w-date').value;
      const type     = document.getElementById('w-type').value;
      const dur      = parseFloat(document.getElementById('w-duration').value);
      const dist     = parseFloat(document.getElementById('w-distance').value) || 0;
      const cal      = parseInt(document.getElementById('w-calories').value) || 0;
      const notes    = document.getElementById('w-notes').value.trim();
      if (!date || !dur) return alert('Date and duration are required.');
      const all = Storage.get('ft_activities', []);
      all.unshift({
        id: crypto.randomUUID(),
        date, type, duration:dur, distance:dist, calories:cal, notes
      });
      Storage.set('ft_activities', all);
      modal.classList.remove('active');
    });

    // ─── 7) Charts Setup ─────────────────────────────────
    const actCtx  = document.getElementById('activityChart').getContext('2d'),
          distCtx = document.getElementById('distributionChart').getContext('2d');

    const activityChart = new Chart(actCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Minutes', data: [], borderColor: '#ff9800', backgroundColor: 'rgba(255,152,0,0.2)', fill:true, tension:.3 }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
    });

    const distributionChart = new Chart(distCtx, {
      type: 'pie',
      data: { labels:['Cardio','Strength','Flexibility','Other'], datasets:[{ data: [], backgroundColor:['rgba(255,152,0,0.8)','rgba(76,175,80,0.8)','rgba(3,169,244,0.8)','rgba(255,87,34,0.8)'] }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
    });

    // ─── 8) TOUR FUNCTION ───────────────────────────────
    function runTour(steps) {
      let idx = 0;
      const ov = document.getElementById('tour-overlay'),
            tt = document.getElementById('tour-tooltip');
      ov.style.display = tt.style.display = 'block';
      function show() {
        const { sel, msg } = steps[idx],
              el = document.querySelector(sel),
              r  = el.getBoundingClientRect();
        tt.innerHTML = `<p class="animate__animated animate__fadeIn">${msg}</p>
                        <button>${idx===steps.length-1?'Done':'Next'}</button>`;
        tt.style.top  = `${r.bottom + 8}px`;
        tt.style.left = `${r.left}px`;
        tt.querySelector('button').onclick = () => {
          idx++;
          if (idx<steps.length) show();
          else { ov.style.display = tt.style.display = 'none'; }
        };
      }
      show();
    }

    // ─── 9) UPDATE FUNCTIONS ─────────────────────────────
    function updateProfileSummary() {
      const p = Storage.get('ft_profile', {});
      document.getElementById('dash-name').textContent = cur.name;
      document.getElementById('dash-avatar').src = p.avatar || `https://i.pravatar.cc/150?u=${cur.email}`;
    }

    function updateStats() {
      const acts = Storage.get('ft_activities', []);
      const now  = new Date(),
            todayKey = now.toISOString().slice(0,10);

      // Monthly
      const thisMonth = acts.filter(a => {
        const d = new Date(a.date);
        return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
      });
      document.getElementById('workoutsCount').textContent = thisMonth.length;
      document.getElementById('distanceCount').textContent = thisMonth.reduce((s,a)=>s+(a.distance||0),0).toFixed(1)+' km';
      document.getElementById('caloriesCount').textContent = thisMonth.reduce((s,a)=>s+(a.calories||0),0);
      document.getElementById('activeDaysCount').textContent = new Set(thisMonth.map(a=>a.date)).size;

      // Today
      const todayTotal = acts.filter(a=>a.date===todayKey).reduce((s,a)=>s+a.duration,0);
      document.getElementById('todayTime').textContent = todayTotal+' min';
      document.getElementById('avgCalories').textContent = thisMonth.length
        ? Math.round(thisMonth.reduce((s,a)=>s+a.calories,0)/thisMonth.length)
        : 0;

      // Progress Bars
      const weekCount = acts.filter(a=>{
        const d = new Date(a.date);
        return (now-d)/(1000*60*60*24) <= 7;
      }).length;
      document.getElementById('progressBar').style.width   = Math.min(100,Math.round(weekCount/5*100))+'%';
      document.getElementById('goalDaily').style.width     = Math.min(100,Math.round(todayTotal/30*100))+'%';
      document.getElementById('goalWeekly').style.width    = Math.min(100,Math.round(weekCount/5*100))+'%';
      document.getElementById('goalMonthly').style.width   = Math.min(100,Math.round(thisMonth.length/20*100))+'%';
    }

    function updateCharts() {
      const acts = Storage.get('ft_activities', []);
      // Line chart: last 7 days
      const labels=[], dataLine=[];
      for(let d=6; d>=0; d--){
        const day = new Date(); day.setDate(day.getDate()-d);
        const key = day.toISOString().slice(0,10);
        labels.push(day.toLocaleDateString(undefined,{weekday:'short'}));
        dataLine.push(acts.filter(a=>a.date===key).reduce((s,a)=>s+a.duration,0));
      }
      activityChart.data.labels = labels;
      activityChart.data.datasets[0].data = dataLine;
      activityChart.update();

      // Pie chart: by type
      const categories=['Cardio','Strength','Flexibility','Other'];
      const counts = categories.map(cat =>
        acts.filter(a => a.type===cat).length
      );
      distributionChart.data.datasets[0].data = counts;
      distributionChart.update();
    }

    function updateRecentActivities() {
      const acts = Storage.get('ft_activities', []).slice(0,5);
      const tbody = document.getElementById('recent-acts');
      tbody.innerHTML = '';
      acts.forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.date}</td>
          <td>${a.type||'–'}</td>
          <td>${a.duration}</td>
          <td>${a.distance||'–'}</td>
        `;
        tbody.appendChild(tr);
      });
      // Fast stats
      document.getElementById('avg-dur').textContent = acts.length
        ? Math.round(acts.reduce((s,a)=>s+a.duration,0)/acts.length)
        : 0;
      document.getElementById('tot-dist').textContent = acts.reduce((s,a)=>s+(a.distance||0),0);
      document.getElementById('tot-cal').textContent = acts.reduce((s,a)=>s+(a.calories||0),0);
    }

    function updateMiniLeaderboard() {
      const list = Storage.get('ft_leaderboard', []).sort((a,b)=>b.score-a.score).slice(0,5);
      const ol = document.getElementById('miniLeaderboard');
      ol.innerHTML = '';
      list.forEach(u => {
        const li = document.createElement('li');
        li.textContent = `${u.name}: ${u.score}`;
        ol.appendChild(li);
      });
    }

    function updateLiveSessions() {
      const sessions = Storage.get('ft_liveSessions', []).sort((a,b)=>new Date(a.start)-new Date(b.start));
      const sched    = Storage.get('ft_mySchedules', []);
      const grid     = document.getElementById('liveSessionsGrid');
      grid.innerHTML = '';
      sessions.forEach(s => {
        const start = new Date(s.start);
        const future = start > new Date();
        const btnText = future
          ? (sched.includes(s.id) ? '✔ Scheduled' : 'Schedule')
          : 'Join Now';
        const cls = future ? 'schedule-btn' : 'join-btn';
        grid.insertAdjacentHTML('beforeend', `
          <div class="live-card">
            <img src="${s.img}" alt="${s.title}">
            <h3>${s.title}</h3>
            <p>${s.host} • ${start.toLocaleString()}</p>
            <button data-id="${s.id}" class="${cls}">${btnText}</button>
          </div>
        `);
      });
    }

    // Handle scheduling / joining
    document.getElementById('liveSessionsGrid').addEventListener('click', e => {
      if (e.target.matches('.schedule-btn')) {
        const id = e.target.dataset.id;
        let sched = Storage.get('ft_mySchedules', []);
        if (!sched.includes(id)) {
          sched.push(id);
          Storage.set('ft_mySchedules', sched);
        }
      }
      if (e.target.matches('.join-btn')) {
        location.href = `live.html?session=${e.target.dataset.id}`;
      }
    });

    function updateDailyTip() {
      const tips = [
        'Stay hydrated—aim for 2 liters of water today.',
        'Incorporate 5 minutes of stretching before your workout.',
        'Take the stairs instead of the elevator today.',
        'Try a new workout type to challenge your muscles.'
      ];
      // change once per day
      const idx = new Date().getDate() % tips.length;
      document.getElementById('tip-of-day').textContent = tips[idx];
    }

    function updateDailyChallenge() {
      const challenges = [
        'Do 50 squats throughout the day.',
        'Walk 10,000 steps.',
        'Hold a plank for 2 minutes in total.',
        'Try a 5‑minute meditation post‑workout.'
      ];
      const idx = Math.floor(Date.now() / (1000*60*60*24)) % challenges.length;
      document.getElementById('dailyChallenge').textContent = challenges[idx];
    }

    function updateCommunityFeed() {
      const feed = Storage.get('ft_communityFeed', [
        { user:'Alex', msg:'Just smashed my 5K PB!' },
        { user:'Taylor', msg:'Anyone up for a yoga session today?' }
      ]);
      const ul = document.getElementById('communityFeed');
      ul.innerHTML = '';
      feed.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.user}: ${item.msg}`;
        ul.appendChild(li);
      });
    }

    function updateAchievements() {
      const allAch = Storage.get('ft_achievements', [
        { id:'first', name:'First Workout', icon:'🏅' },
        { id:'streak5', name:'5‑Day Streak', icon:'🔥' }
      ]);
      const earned = Storage.get('ft_profile', {}).achievements || [];
      const grid = document.getElementById('yourAchievements');
      grid.innerHTML = '';
      allAch.forEach(a => {
        const div = document.createElement('div');
        div.className = 'achievement-badge ' + (earned.includes(a.id)?'unlocked':'');
        div.innerHTML = `<i>${a.icon}</i><p>${a.name}</p>`;
        grid.appendChild(div);
      });
    }

    // ─── 10) WIRE UP STORAGE CHANGES ───────────────────────
    ['ft_activities','ft_profile','ft_leaderboard','ft_liveSessions','ft_mySchedules','ft_communityFeed','ft_achievements']
      .forEach(key => Storage.onChange(key, updateDashboard));

    // ─── 11) MASTER UPDATE ───────────────────────────────
    function updateDashboard() {
      updateProfileSummary();
      updateStats();
      updateCharts();
      updateRecentActivities();
      updateMiniLeaderboard();
      updateLiveSessions();
      updateDailyTip();
      updateDailyChallenge();
      updateCommunityFeed();
      updateAchievements();
    }

    // Initial draw
    updateDashboard();
  });
  </script>
</body>
</html>
