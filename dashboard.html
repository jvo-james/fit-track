<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FitTrack | Dashboard</title>

  <!-- Google Fonts & FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <script defer src="https://kit.fontawesome.com/a2e8f1b6b1.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="storage.js"></script>

  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --gold: #ff9800;
      --accent: rgba(255,255,255,0.1);
      --font-base: 'Raleway', sans-serif;
      --font-head: 'Poppins', sans-serif;
      --transition: .3s ease;
      --sidebar-w: 80px;
      --header-z: 300;
      --sidebar-z: 200;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      display:flex; flex-direction:row; min-height:100vh;
      background:var(--bg); color:var(--fg);
      font-family:var(--font-base); overflow:hidden;
    }
    a { color:inherit; text-decoration:none; }
    button { font-family:var(--font-head); cursor:pointer; transition:var(--transition); }

    /* Sidebar */
    .sidebar {
      width:var(--sidebar-w); background:rgba(0,0,0,0.9);
      border-right:2px solid var(--gold);
      display:flex; flex-direction:column; align-items:center;
      padding-top:1rem; position:sticky; top:0; height:100vh;
      z-index:var(--sidebar-z);
    }
    .sidebar .logo { font-size:1.6rem; color:var(--gold); margin-bottom:2rem; }
    .sidebar a, .sidebar button.profile-menu {
      width:100%; padding:.8rem 0; text-align:center;
      color:var(--fg); background:transparent; border:none;
    }
    .sidebar a.active, .sidebar a:hover, .sidebar button:hover {
      background:var(--accent);
    }
    .sidebar i, .sidebar img.avatar { font-size:1.2rem; }
    .sidebar img.avatar { width:32px; height:32px; border-radius:50%; object-fit:cover; border:2px solid var(--gold); }
    .sidebar span { display:block; font-size:.75rem; }

    /* Main layout */
    .main {
      flex:1; display:flex; flex-direction:column; overflow:hidden;
    }
    header {
      position:sticky; top:0; z-index:var(--header-z);
      background:rgba(0,0,0,0.9); border-bottom:2px solid var(--gold);
      padding:1rem; display:flex; align-items:center; justify-content:space-between;
    }
    header h1 { margin:0; font-size:1.4rem; flex:1; text-align:center; }
    header .controls { display:flex; gap:1rem; }
    header .controls button { background:var(--gold); color:var(--bg); border:none; padding:.5rem 1rem; border-radius:20px; }

    /* Notification bar */
    #notif-bar {
      display:flex; align-items:center; justify-content:space-between;
      background:rgba(255,152,0,0.1); border-left:4px solid var(--gold);
      padding:.8rem 1.5rem; font-size:.95rem;
    }
    #notif-bar.hidden { display:none; }

    /* Content */
    .content {
      flex:1; overflow-y:auto; padding:1rem;
      display:grid; gap:1.5rem;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
    }

    /* Stats & Progress */
    .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:1rem; }
    .stat-card {
      background:rgba(255,255,255,0.05); border-radius:8px;
      padding:1rem; text-align:center; transition:var(--transition);
    }
    .stat-card:hover { background:rgba(255,255,255,0.1); }
    .stat-card i { font-size:1.5rem; color:var(--gold); margin-bottom:.5rem; }
    .progress, .goals, .charts { grid-column:1/-1; }

    .bar-container, .goal-container {
      background:rgba(255,255,255,0.2); border-radius:6px; overflow:hidden; height:12px;
    }
    .bar-fill, .goal-fill {
      height:100%; background:var(--gold); width:0%; transition:width 1s ease;
    }

    /* Live sessions */
    .live-sessions { grid-column:1/-1; }
    .live-sessions h2 { font-size:1.2rem; color:var(--gold); margin-bottom:.5rem; }
    .live-grid { display:grid; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); }
    .live-card {
      background:rgba(255,255,255,0.05); border-radius:8px; padding:1rem;
      display:flex; flex-direction:column; align-items:center; gap:.5rem;
      transition:var(--transition);
    }
    .live-card:hover { background:rgba(255,255,255,0.1); }
    .live-card img { width:100%; height:120px; object-fit:cover; border-radius:6px; }
    .live-card button {
      margin-top:auto; background:var(--gold); color:var(--bg);
      border:none; padding:.4rem .8rem; border-radius:6px;
    }

    /* Achievements */
    .achievements { grid-column:1/-1; }
    .ach-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(80px,1fr)); gap:1rem; }
    .badge { background:rgba(255,255,255,0.05); border-radius:8px; text-align:center; padding:.5rem; opacity:.4; transition:opacity .3s; }
    .badge.unlocked { opacity:1; }
    .badge i { font-size:1.4rem; color:var(--gold); margin-bottom:.3rem; }

    /* Guided tour tooltips */
    .tour-overlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.7);
      display:none; z-index:400; pointer-events:none;
    }
    .tour-tooltip {
      position:absolute; background:var(--fg); color:var(--bg);
      padding:.8rem; border-radius:6px; max-width:200px; pointer-events:auto;
      box-shadow:0 2px 6px rgba(0,0,0,0.5);
      font-size:.9rem; line-height:1.2;
    }
    .tour-tooltip button {
      margin-top:.5rem; background:var(--gold); color:var(--bg);
      border:none; padding:.3rem .6rem; border-radius:4px;
      font-size:.8rem;
    }

    /* Footer */
    footer {
      text-align:center; padding:1rem; background:rgba(0,0,0,0.9);
      border-top:2px solid var(--gold);
    }

    /* Responsive tweaks */
    @media(max-width:800px) {
      header { flex-wrap:wrap; }
      .content { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo"><i class="fas fa-heartbeat"></i></div>
    <a href="dashboard.html" class="menu-item active"><i class="fas fa-tachometer-alt"></i><span>Dash</span></a>
    <a href="log.html" class="menu-item"><i class="fas fa-pen"></i><span>Log</span></a>
    <a href="workouts.html" class="menu-item"><i class="fas fa-dumbbell"></i><span>Workouts</span></a>
    <a href="leaderboard.html" class="menu-item"><i class="fas fa-trophy"></i><span>Board</span></a>
    <button class="profile-menu"><img id="side-avatar" class="avatar" src=""><span>Profile</span></button>
    <a href="home.html" class="menu-item sign-out"><i class="fas fa-sign-out-alt"></i><span>Sign Out</span></a>
  </aside>

  <div class="main">
    <!-- Header & notifications -->
    <header>
      <h1 id="greeting">Welcome</h1>
      <div class="controls">
        <button id="new-workout"><i class="fas fa-plus"></i> New Workout</button>
      </div>
    </header>
    <div id="notif-bar" class="notif-bar hidden">
      ðŸ‘‹ Donâ€™t forget to <a href="profile.html">complete your profile</a>!
      <button id="notif-close">&times;</button>
    </div>

    <!-- Content grid -->
    <div class="content">
      <!-- Stats -->
      <section class="stats" data-tour="stats">
        <div class="stat-card"><i class="fas fa-dumbbell"></i><h3 id="workoutsCount">0</h3><p>This Month</p></div>
        <div class="stat-card"><i class="fas fa-road"></i><h3 id="distanceCount">0 km</h3><p>Distance</p></div>
        <div class="stat-card"><i class="fas fa-fire"></i><h3 id="caloriesCount">0</h3><p>Calories</p></div>
        <div class="stat-card"><i class="fas fa-calendar-day"></i><h3 id="activeDaysCount">0</h3><p>Active Days</p></div>
      </section>

      <!-- Weekly progress -->
      <section class="progress" data-tour="progress">
        <h3><i class="fas fa-chart-line"></i> Weekly Goal</h3>
        <div class="bar-container"><div id="progressBar" class="bar-fill"></div></div>
      </section>

      <!-- Daily/Weekly/Monthly goals -->
      <section class="goals" data-tour="goals">
        <div><p>Daily: 30â€¯min</p><div class="goal-container"><div id="goalDaily" class="goal-fill"></div></div></div>
        <div><p>Weekly: 5 workouts</p><div class="goal-container"><div id="goalWeekly" class="goal-fill"></div></div></div>
        <div><p>Monthly: 20 workouts</p><div class="goal-container"><div id="goalMonthly" class="goal-fill"></div></div></div>
      </section>

      <!-- Charts -->
      <section class="charts" data-tour="charts">
        <div class="chart-card"><h3>Activity Over Time</h3><canvas id="activityChart"></canvas></div>
        <div class="chart-card"><h3>Workout Distribution</h3><canvas id="distributionChart"></canvas></div>
      </section>

      <!-- Upcoming live sessions -->
      <section class="live-sessions" data-tour="live">
        <h2>Upcoming Live Sessions</h2>
        <div class="live-grid" id="liveSessionsGrid"></div>
      </section>

      <!-- Achievements -->
      <section class="achievements" data-tour="achievements">
        <h2>Your Achievements</h2>
        <div class="ach-grid" id="yourAchievements"></div>
      </section>
    </div>

    <footer>
      &copy; 2025 FitTrack. All rights reserved.
    </footer>
  </div>

  <!-- Guided tour overlay -->
  <div id="tour-overlay" class="tour-overlay"></div>
  <div id="tour-tooltip" class="tour-tooltip"></div>

  <!-- New Workout Modal -->
  <div id="workout-modal" class="modal-overlay">
    <div class="modal">
      <button id="workout-close" class="close">&times;</button>
      <h2>Log New Workout</h2>
      <input type="date" id="w-date" />
      <input type="number" id="w-duration" placeholder="Duration (mins)" />
      <button id="w-save" class="primary">Save Workout</button>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1) Authentication & redirect
    const curJSON = localStorage.getItem('ft_current');
    if (!curJSON) return location.href='home.html';
    const cur = JSON.parse(curJSON);
    if (!cur.name) return location.href='home.html';

    // 2) Greeting & firstâ€‘time tour flag
    const greet = document.getElementById('greeting');
    if (cur.isNew) {
      greet.textContent = `ðŸ‘‹ Hello ${cur.name}!`;
    } else {
      greet.textContent = `Welcome back, ${cur.name}!`;
    }

    // 3) Load profile avatar
    const prof = JSON.parse(localStorage.getItem('ft_profile')||'{}');
    ['side-avatar'].forEach(id=>{
      const ico = document.getElementById(id);
      if (ico && prof.avatar) {
        ico.src = prof.avatar;
      } else if (ico) {
        ico.outerHTML = '<i class="fas fa-user-circle avatar"></i>';
      }
    });

    // 4) Notification bar if profile incomplete
    const notifBar = document.getElementById('notif-bar'),
          notifClose = document.getElementById('notif-close');
    if (!cur.bio || !prof.avatar) notifBar.classList.remove('hidden');
    notifClose.onclick = ()=> notifBar.classList.add('hidden');

    // 5) Sidebar nav buttons
    document.querySelectorAll('.sidebar a, .sidebar button').forEach(el=>{
      el.onclick = ()=> { /* autoâ€‘navigate */ };
    });

    // 6) Build stats from ft_activities
    const acts = JSON.parse(localStorage.getItem('ft_activities')||'[]'),
          stats = cur.stats||{};
    document.getElementById('workoutsCount').textContent = acts.length;
    const totDist = acts.reduce((s,a)=>s+(+a.distance||0),0).toFixed(1);
    document.getElementById('distanceCount').textContent = totDist+' km';
    const totCal = acts.reduce((s,a)=>s+(+a.calories||0),0);
    document.getElementById('caloriesCount').textContent = totCal;
    const days = [...new Set(acts.map(a=>a.date))].length;
    document.getElementById('activeDaysCount').textContent = days;

    // 7) Progress bars
    const today = new Date().toISOString().slice(0,10),
          todayMin = acts.filter(a=>a.date===today).reduce((s,a)=>s+(+a.duration||0),0);
    const weekCount = acts.filter(a=>{
      const d=new Date(a.date), n=new Date();
      return (n-d)/(1000*60*60*24)<=7;
    }).length;
    document.getElementById('progressBar').style.width = Math.min(100,weekCount/5*100)+'%';
    document.getElementById('goalDaily').style.width = Math.min(100,todayMin/30*100)+'%';
    document.getElementById('goalWeekly').style.width = Math.min(100,weekCount/5*100)+'%';
    document.getElementById('goalMonthly').style.width = Math.min(100,acts.length/20*100)+'%';

    // 8) Charts data
    const cd = cur.chartData||{labels:[],activity:[],distribution:[]};
    new Chart(document.getElementById('activityChart'), {
      type:'line', data:{labels:cd.labels,datasets:[{
        label:'Minutes', data:cd.activity,
        borderColor:var(--gold), backgroundColor:'rgba(255,152,0,0.2)', fill:true, tension:.3
      }]}, options:{responsive:true,maintainAspectRatio:false}
    });
    new Chart(document.getElementById('distributionChart'), {
      type:'pie', data:{labels:['Cardio','Strength','Flex','Other'],
        datasets:[{data:cd.distribution, backgroundColor:[
          'rgba(255,152,0,0.8)','rgba(255,87,34,0.8)',
          'rgba(76,175,80,0.8)','rgba(3,169,244,0.8)'
        ]}]}, options:{responsive:true,maintainAspectRatio:false}
    });

    // 9) Upcoming live sessions (and scheduling)
    let sessions = JSON.parse(localStorage.getItem('ft_liveSessions')||'[]');
    const liveGrid = document.getElementById('liveSessionsGrid');
    function renderSessions(){
      liveGrid.innerHTML = '';
      sessions.sort((a,b)=>new Date(a.start)-new Date(b.start))
        .forEach(s=>{
          const card = document.createElement('div');
          card.className='live-card';
          card.innerHTML=`
            <img src="${s.img||'placeholder.jpg'}">
            <h3>${s.title}</h3>
            <p>${s.host} â€¢ ${new Date(s.start).toLocaleString()}</p>
            ${new Date(s.start)>new Date()
              ? `<button data-id="${s.id}">Schedule</button>`
              : `<button data-join="${s.id}">Join Now</button>`
            }
          `;
          liveGrid.appendChild(card);
        });
      // attach schedule
      liveGrid.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = e=>{
          const id=e.target.dataset.id;
          let sched = JSON.parse(localStorage.getItem('ft_mySchedules')||'[]');
          if (!sched.includes(id)) {
            sched.push(id);
            localStorage.setItem('ft_mySchedules',JSON.stringify(sched));
            alert('Scheduled! Weâ€™ll remind you.');
          }
        };
      });
    }
    renderSessions();

    // 10) Achievements
    const thresh = [
      {n:1, icon:'fas fa-star', text:'First Workout'},
      {n:5, icon:'fas fa-medal', text:'5 Workouts'},
      {n:10,icon:'fas fa-trophy', text:'10 Workouts'},
      {n:30,icon:'fas fa-award', text:'30 Workouts'}
    ];
    const achGrid = document.getElementById('yourAchievements');
    thresh.forEach(t=>{
      const d=document.createElement('div');
      d.className='badge'+(acts.length>=t.n?' unlocked':'');
      d.innerHTML=`<i class="${t.icon}"></i><p>${t.text}</p>`;
      achGrid.appendChild(d);
    });

    // 11) Newâ€‘workout modal
    const modal = document.getElementById('workout-modal'),
          openM = document.getElementById('new-workout'),
          closeM= document.getElementById('workout-close'),
          saveM = document.getElementById('w-save');
    openM.onclick = ()=>modal.classList.add('active');
    closeM.onclick= ()=>modal.classList.remove('active');
    modal.onclick = e=>{ if(e.target===modal) modal.classList.remove('active'); };
    saveM.onclick=()=>{
      const date=document.getElementById('w-date').value,
            dur =document.getElementById('w-duration').value;
      if(!date||!dur) return alert('Please fill both fields');
      acts.unshift({date, duration:dur});
      localStorage.setItem('ft_activities', JSON.stringify(acts));
      location.reload();
    };

    // 12) Guided walkthrough for new users
    if (cur.isNew) startTour();
    function startTour(){
      const steps = [
        { sel:'[data-tour="stats"]', text:'Here are your key stats for the month.' },
        { sel:'[data-tour="progress"]', text:'Track your weekly goal progress here.' },
        { sel:'[data-tour="live"]', text:'See & schedule live sessions!' },
        { sel:'[data-tour="achievements"]', text:'Earn badges as you progress.' }
      ];
      let idx=0;
      const overlay=document.getElementById('tour-overlay'),
            tip=document.getElementById('tour-tooltip');
      overlay.style.display='block';
      showStep();
      function showStep(){
        const {sel,text}=steps[idx],
              el=document.querySelector(sel),
              r=el.getBoundingClientRect();
        tip.innerHTML = `<p>${text}</p>
                         <button id="tour-next">${idx<steps.length-1?'Next':'Done'}</button>`;
        tip.style.top=`${r.bottom+8}px`;
        tip.style.left=`${r.left}px`;
        tip.style.display='block';
        document.getElementById('tour-next').onclick=()=>{
          idx++;
          if(idx<steps.length) showStep();
          else endTour();
        };
      }
      function endTour(){
        overlay.style.display='none';
        tip.style.display='none';
        cur.isNew=false;
        localStorage.setItem('ft_current',JSON.stringify(cur));
      }
    }
  });
  </script>
</body>
</html>
